import fs from 'fs'
import yaml from 'yaml'

const signals_railway_line = yaml.parse(fs.readFileSync('features/train_protection.yaml', 'utf8'))
const loading_gauges = yaml.parse(fs.readFileSync('features/loading_gauge.yaml', 'utf8'))
const track_classes = yaml.parse(fs.readFileSync('features/track_class.yaml', 'utf8'))

const knownStyles = [
  'standard',
  'speed',
  'signals',
  'electrification',
  'gauge',
  'loading_gauge',
  'track_class',
  'operator',
];

const defaultDate = (new Date()).getFullYear();

const themeSwitch = (light, dark) =>
  ['case',
    ['==', ['global-state', 'theme'], 'light'], light,
    dark
  ];

const colors = {
  text: {
    main: themeSwitch('black', 'white'),
    halo: themeSwitch('white', 'black'),
  },
  halo: themeSwitch('white', '#333'),
  iconHalo: themeSwitch('white', '#ccc'),
  casing: themeSwitch('white', '#666'),
  hover: {
    main: themeSwitch('#ff0000', '#ff0000'),
    // High speed lines and 25kV are the hover color by default
    alternative: themeSwitch('#ffc107', '#ffc107'),
    textHalo: themeSwitch('yellow', '#28281e'),
    iconHalo: themeSwitch('yellow', '#E7E700'),
  },
  railwayLine: {
    text: themeSwitch('#585858', '#ccc'),
  },
  styles: {
    standard: {
      main: themeSwitch('#ff8100', '#ff8100'),
      highspeed: themeSwitch('#ff0c00', '#ff0c00'),
      branch: themeSwitch('#c4b600', '#c4b600'),
      narrowGauge: themeSwitch('#c0da00', '#c0da00'),
      no_usage: themeSwitch('#000000', '#000000'),
      disused: themeSwitch('#70584d', '#70584d'),
      tourism: themeSwitch('#5b4d70', '#5b4d70'),
      military: themeSwitch('#764765', '#764765'),
      test: themeSwitch('#3d634e', '#3d634e'),
      abandoned: themeSwitch('#7f6a62', '#7f6a62'),
      razed: themeSwitch('#94847e', '#94847e'),
      tram: themeSwitch('#d877b8', '#d877b8'),
      subway: themeSwitch('#0300c3', '#0300c3'),
      light_rail: themeSwitch('#00bd14', '#00bd14'),
      monorail: themeSwitch('#00bd8b', '#00bd8b'),
      miniature: themeSwitch('#7d7094', '#7d7094'),
      funicular: themeSwitch('#d87777', '#d87777'),
      siding: themeSwitch('#000000', '#000000'),
      crossover: themeSwitch('#000000', '#000000'),
      yard: themeSwitch('#000000', '#000000'),
      spur: themeSwitch('#87491d', '#87491d'),
      industrial: themeSwitch('#87491d', '#87491d'),
      ferry: themeSwitch('#1e81b0', '#1e81b0'),
      unknown: themeSwitch('#000000', '#000000'),
      casing: {
        railway: themeSwitch('#ffffff', '#ffffff'),
        bridge: themeSwitch('#000000', '#ddd'),
      },
      tunnelCover: themeSwitch('rgba(255, 255, 255, 50%)', 'rgba(0, 0, 0, 25%)'),
      turntable: {
        fill: themeSwitch('#ababab', '#ababab'),
        casing: themeSwitch('#808080', '#808080'),
      },
      stationsText: themeSwitch('blue', '#bdcfff'),
      yardText: themeSwitch('#87491D', '#ffa35f'),
      tramStopText: themeSwitch('#D877B8', '#f8c7e8'),
      lightRailText: themeSwitch('#0e5414', '#83ea8f'),
      monorailText: themeSwitch('#00674d', '#5fffd7'),
      miniatureText: themeSwitch('#503285', '#503285'),
      funicularText: themeSwitch('#d75656', '#daa3a3'),
      defaultText: themeSwitch('#616161', '#d2d2d2'),
      past: themeSwitch('#535353', '#dadada'),
      future: themeSwitch('#fff732', '#fffdcc'),
      signalBox: {
        text: themeSwitch('#404040', '#bfffb3'),
        halo: themeSwitch('#bfffb3', '#404040'),
      },
      track: {
        text: themeSwitch('white', 'white'),
        halo: themeSwitch('blue', '#00298d'),
        hover: themeSwitch('yellow', 'yellow'),
      },
      switch: {
        default: themeSwitch('#003687', '#a7c6fc'),
        localOperated: themeSwitch('#005129', '#85f5bd'),
        resetting: themeSwitch('#414925', '#bdc2ab'),
      },
      symbols: themeSwitch('black', 'white'),
      platform: themeSwitch('#aaa', '#aaa'),
      stationAreaGroup: themeSwitch('black', 'white'),
    },
    signals: {
      bufferStopDerailer: themeSwitch('#BF1A1D', '#E75454'),
    },
  },
  km: {
    text: themeSwitch('hsl(268, 100%, 40%)', 'hsl(268, 5%, 86%)'),
  },
  signals: {
    direction: themeSwitch('#a8d8bcff', '#a8d8bcff'),
  },
  catenary: themeSwitch('blue', 'blue'),
  substation: themeSwitch('hsl(152 100% 36.3%)', 'hsl(152 100% 25%)'),
  substationText: themeSwitch('hsl(152 100% 20.8%)', 'hsl(152 100% 50%)'),
};

const font = {
  regular: [
    'Noto Sans Regular',
    'Noto Naskh Arabic Regular',
    'Noto Sans Armenian Regular',
    'Noto Sans Balinese Regular',
    'Noto Sans Bengali Regular',
    'Noto Sans Devanagari Regular',
    'Noto Sans Ethiopic Regular',
    'Noto Sans Georgian Regular',
    'Noto Sans Gujarati Regular',
    'Noto Sans Gurmukhi Regular',
    'Noto Sans Hebrew Regular',
    'Noto Sans Javanese Regular',
    'Noto Sans Kannada Regular',
    'Noto Sans Khmer Regular',
    'Noto Sans Lao Regular',
    'Noto Sans Mongolian Regular',
    'Noto Sans Myanmar Regular',
    'Noto Sans Oriya Regular',
    'Noto Sans Sinhala Regular',
    'Noto Sans Symbols Regular',
    'Noto Sans Tamil Regular',
    'Noto Sans Thai Regular',
    'Noto Sans Tibetan Regular',
    'Noto Sans Tifinagh Regular',
  ],
  bold: [
    'Noto Sans Bold',
    'Noto Naskh Arabic Bold',
    'Noto Sans Armenian Bold',
    'Noto Sans Bengali Bold',
    'Noto Sans Devanagari Bold',
    'Noto Sans Ethiopic Bold',
    'Noto Sans Georgian Bold',
    'Noto Sans Gujarati Bold',
    'Noto Sans Gurmukhi Bold',
    'Noto Sans Hebrew Bold',
    'Noto Sans Kannada Bold',
    'Noto Sans Khmer Bold',
    'Noto Sans Lao Bold',
    'Noto Sans Myanmar Bold',
    'Noto Sans Oriya Bold',
    'Noto Sans Sinhala Bold',
    'Noto Sans Symbols Bold',
    'Noto Sans Tamil Bold',
    'Noto Sans Thai Bold',
    'Noto Sans Tibetan Bold',
    // Fallback to regular fonts
    'Noto Sans Balinese Regular',
    'Noto Sans Javanese Regular',
    'Noto Sans Mongolian Regular',
    'Noto Sans Tifinagh Regular',
  ],
  italic: [
    'Noto Sans Italic',
    // Fallback to regular fonts
    'Noto Naskh Arabic Regular',
    'Noto Sans Armenian Regular',
    'Noto Sans Balinese Regular',
    'Noto Sans Bengali Regular',
    'Noto Sans Devanagari Regular',
    'Noto Sans Ethiopic Regular',
    'Noto Sans Georgian Regular',
    'Noto Sans Gujarati Regular',
    'Noto Sans Gurmukhi Regular',
    'Noto Sans Hebrew Regular',
    'Noto Sans Javanese Regular',
    'Noto Sans Kannada Regular',
    'Noto Sans Khmer Regular',
    'Noto Sans Lao Regular',
    'Noto Sans Mongolian Regular',
    'Noto Sans Myanmar Regular',
    'Noto Sans Oriya Regular',
    'Noto Sans Sinhala Regular',
    'Noto Sans Symbols Regular',
    'Noto Sans Tamil Regular',
    'Noto Sans Thai Regular',
    'Noto Sans Tibetan Regular',
    'Noto Sans Tifinagh Regular',
    'Noto Sans Regular',
  ],
}

const turntable_casing_width = 2;

const trainProtectionColor = field => ['case',
  ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
  ...signals_railway_line.train_protections.flatMap(train_protection =>
    [['==', ['get', field], train_protection.train_protection], train_protection.color]),
  'grey',
];

const railway_casing_add = 1;
const bridge_casing_add = 3;

// TODO move to variable
const abandoned_dasharray = [2.5, 2.5];
const disused_dasharray = [2.5, 2.5];
const razed_dasharray = [1, 5];
const construction_dasharray = [4.5, 4.5];
const proposed_dasharray = [1, 4];
const present_dasharray = [1];

const train_protection_construction_dasharray = [2, 8];

// Turbo color map
// See https://research.google/blog/turbo-an-improved-rainbow-colormap-for-visualization/
// See https://gist.github.com/mikhailov-work/ee72ba4191942acecc03fe6da94fc73f?permalink_comment_id=3708728#gistcomment-3708728
// See https://github.com/hiddewie/OpenRailwayMap-vector/issues/668
const turboColorMap = (property, min, max, power) =>
  ['interpolate-hcl', ['linear'], ['^', ['/', ['-', ['max', min, ['min', ['get', property], max]], min], max - min], power],
    0, 'hsl(285 53.2% 15.1%)',
    25 / 255, 'hsl(231 57% 53.5%)',
    50 / 255, 'hsl(212 101.1% 62.7%)',
    75 / 255, 'hsl(179 78.2% 46.7%)',
    100 / 255, 'hsl(145 92% 45%)',
    125 / 255, 'hsl(91 100% 45%)',
    150 / 255, 'hsl(62 75.5% 55%)',
    175 / 255, 'hsl(36 99% 60.2%)',
    200 / 255, 'hsl(21 91.7% 52.5%)',
    225 / 255, 'hsl(12 96.2% 41.4%)',
    250 / 255, 'hsl(3 97.2% 27.8%)',
    255 / 255, 'hsl(1 95.2% 24.7%)',
  ]

const speedColor = ['case',
  ['==', ['get', 'maxspeed'], null], 'gray',
  turboColorMap('maxspeed', 10, 380, 0.8),
]
const speedHoverColor = ['case',
  ['all', ['!=', ['get', 'maxspeed'], null], ['>=', ['get', 'maxspeed'], 200], ['<=', ['get', 'maxspeed'], 340]], colors.hover.alternative,
  colors.hover.main,
]

const electrification_construction_dashes = [2.5, 2.5];
const electrification_proposed_dashes = [2, 4];

const color_no = 'black';
const color_delectrified = '#70584D';
const color_lt750v_dc = '#FF79B8';
const color_750v_dc = '#F930FF';
const color_gt750v_lt1kv_dc = '#D033FF';
const color_1kv_dc = '#5C1CCB';
const color_gt1kv_lt1500v_dc = '#007ACB';
const color_1500v_dc = '#0098CB';
const color_gt1500v_lt3kv_dc = '#00B7CB';
const color_3kv_dc = '#0000FF';
const color_gt3kv_dc = '#1969FF';
const color_lt15kv_ac = '#97FF2F';
const color_gte15kv_lt25kv_ac = '#F1F100';
const color_gte25kv_ac = '#FF9F19';
const color_15kv_16_67hz = '#00FF00';
const color_15kv_16_7hz = '#00CB66';
const color_25kv_50hz = '#FF0000';
const color_25kv_60hz = '#C00000';
const color_12kv_25hz = '#CCCC00';
const color_12_5kv_60hz = '#999900';
const color_20kv_50hz = '#FFCC66';
const color_20kv_60hz = '#FF9966';

const electrificationVoltageFrequencyColor = (voltageProperty, frequencyProperty) => ['case',
  ['boolean', ['feature-state', 'hover'], false], ['case',
    ['==', ['get', voltageProperty], 25000], colors.hover.alternative,
    colors.hover.main,
  ],
  ['all', ['==', ['get', frequencyProperty], 60], ['==', ['get', voltageProperty], 25000]], color_25kv_60hz,
  ['all', ['==', ['get', frequencyProperty], 50], ['==', ['get', voltageProperty], 25000]], color_25kv_50hz,
  ['all', ['==', ['get', frequencyProperty], 60], ['==', ['get', voltageProperty], 20000]], color_20kv_60hz,
  ['all', ['==', ['get', frequencyProperty], 50], ['==', ['get', voltageProperty], 20000]], color_20kv_50hz,
  ['all', ['!=', ['get', frequencyProperty], null], ['<', 16.665, ['get', frequencyProperty]], ['<', ['get', frequencyProperty], 16.675], ['==', ['get', voltageProperty], 15000]], color_15kv_16_67hz,
  ['all', ['!=', ['get', frequencyProperty], null], ['<', 16.65, ['get', frequencyProperty]], ['<', ['get', frequencyProperty], 16.75], ['==', ['get', voltageProperty], 15000]], color_15kv_16_7hz,
  ['all', ['==', ['get', frequencyProperty], 60], ['==', ['get', voltageProperty], 12500]], color_12_5kv_60hz,
  ['all', ['==', ['get', frequencyProperty], 25], ['==', ['get', voltageProperty], 12000]], color_12kv_25hz,
  ['all', ['==', ['get', frequencyProperty], 0], ['!=', ['get', voltageProperty], null], ['>', ['get', voltageProperty], 3000]], color_gt3kv_dc,
  ['all', ['==', ['get', frequencyProperty], 0], ['==', ['get', voltageProperty], 3000]], color_3kv_dc,
  ['all', ['==', ['get', frequencyProperty], 0], ['!=', ['get', voltageProperty], null], ['>', 3000, ['get', voltageProperty]], ['>', ['get', voltageProperty], 1500]], color_gt1500v_lt3kv_dc,
  ['all', ['==', ['get', frequencyProperty], 0], ['==', ['get', voltageProperty], 1500]], color_1500v_dc,
  ['all', ['==', ['get', frequencyProperty], 0], ['!=', ['get', voltageProperty], null], ['>', 1500, ['get', voltageProperty]], ['>', ['get', voltageProperty], 1000]], color_gt1kv_lt1500v_dc,
  ['all', ['==', ['get', frequencyProperty], 0], ['==', ['get', voltageProperty], 1000]], color_1kv_dc,
  ['all', ['==', ['get', frequencyProperty], 0], ['!=', ['get', voltageProperty], null], ['>', 1000, ['get', voltageProperty]], ['>', ['get', voltageProperty], 750]], color_gt750v_lt1kv_dc,
  ['all', ['==', ['get', frequencyProperty], 0], ['==', ['get', voltageProperty], 750]], color_750v_dc,
  ['all', ['==', ['get', frequencyProperty], 0], ['!=', ['get', voltageProperty], null], ['>', 750, ['get', voltageProperty]]], color_lt750v_dc,
  ['all',
    ['!=', ['get', frequencyProperty], 0],
    ['!=', ['get', voltageProperty], null],
    ['any',
      ['>', ['get', voltageProperty], 25000],
      ['all', ['!=', ['get', frequencyProperty], 50], ['!=', ['get', frequencyProperty], 60], ['>', ['get', voltageProperty], 25000]],
    ],
  ], color_gte25kv_ac,
  ['all',
    ['!=', ['get', frequencyProperty], 0],
    ['!=', ['get', voltageProperty], null],
    ['all', ['>', 25000, ['get', voltageProperty]], ['>', ['get', voltageProperty], 15000]]
  ], color_gte15kv_lt25kv_ac,
  ['all',
    ['!=', ['get', frequencyProperty], 0],
    ['!=', ['get', voltageProperty], null],
    ['>', 15000, ['get', voltageProperty]],
  ], color_lt15kv_ac,
  ['any',
    ['==', ['get', 'electrification_state'], 'deelectrified'],
    ['==', ['get', 'electrification_state'], 'abandoned'],
  ], color_delectrified,
  ['any',
    ['==', ['get', 'electrification_state'], 'no'],
    ['==', ['get', 'electrification_state'], 'construction'],
    ['==', ['get', 'electrification_state'], 'proposed'],
  ], color_no,
  'gray',
];

const electrificationVoltageMaximumCurrentColor = (maximumCurrentProperty) => ['case',
  ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
  ['!=', ['get', maximumCurrentProperty], null], turboColorMap(maximumCurrentProperty, 300, 4400, 0.9),
  ['any',
    ['==', ['get', 'electrification_state'], 'deelectrified'],
    ['==', ['get', 'electrification_state'], 'abandoned'],
  ], color_delectrified,
  ['any',
    ['==', ['get', 'electrification_state'], 'no'],
    ['==', ['get', 'electrification_state'], 'construction'],
    ['==', ['get', 'electrification_state'], 'proposed'],
  ], color_no,
  'gray',
];

const gauge_construction_dashes = [3, 3];
const dual_construction_dashes = [1.5, 4.5];
const multi_construction_dashes = [0, 1, 1, 4];
const gauge_dual_gauge_dashes = [4.5, 4.5];
const gauge_multi_gauge_dashes = [0, 3, 3, 3];

const color_gauge_0064 = '#006060';
const color_gauge_0089 = '#008080';
const color_gauge_0127 = '#00A0A0';
const color_gauge_0184 = '#00C0C0';
const color_gauge_0190 = '#00E0E0';
const color_gauge_0260 = '#00FFFF';
const color_gauge_0381 = '#80FFFF';
const color_gauge_0500 = '#A0FFFF';
const color_gauge_0597 = '#C0FFFF';
const color_gauge_0600 = '#E0FFFF';
const color_gauge_0610 = '#FFE0FF';
const color_gauge_0700 = '#FFC0FF';
const color_gauge_0750 = '#FFA0FF';
const color_gauge_0760 = '#FF80FF';
const color_gauge_0762 = '#FF60FF';
const color_gauge_0785 = '#FF40FF';
const color_gauge_0800 = '#FF00FF';
const color_gauge_0891 = '#E000FF';
const color_gauge_0900 = '#C000FF';
const color_gauge_0914 = '#A000FF';
const color_gauge_0950 = '#8000FF';
const color_gauge_1000 = '#6000FF';
const color_gauge_1009 = '#4000FF';
const color_gauge_1050 = '#0000FF';
const color_gauge_1067 = '#0000E0';
const color_gauge_1100 = '#0000C0';
const color_gauge_1200 = '#0000A0';
const color_gauge_1372 = '#000080';
const color_gauge_1422 = '#000060';
const color_gauge_1432 = '#000040';
const color_gauge_1435 = '#000000';
const color_gauge_1440 = '#400000';
const color_gauge_1445 = '#600000';
const color_gauge_1450 = '#700000';
const color_gauge_1458 = '#800000';
const color_gauge_1495 = '#A00000';
const color_gauge_1520 = '#C00000';
const color_gauge_1522 = '#E00000';
const color_gauge_1524 = '#FF0000';
const color_gauge_1581 = '#FF6000';
const color_gauge_1588 = '#FF8000';
const color_gauge_1600 = '#FFA000';
const color_gauge_1668 = '#FFC000';
const color_gauge_1676 = '#FFE000';
const color_gauge_1700 = '#FFFF00';
const color_gauge_1800 = '#E0FF00';
const color_gauge_1880 = '#C0FF00';
const color_gauge_2000 = '#A0FF00';
const color_gauge_miniature = '#80C0C0';
const color_gauge_monorail = '#C0C080';
const color_gauge_broad = '#FFC0C0';
const color_gauge_narrow = '#C0C0FF';
const color_gauge_standard = '#808080';
const color_gauge_unknown = '#C0C0C0';

const gaugeColor = (gaugeProperty, gaugeIntProperty) => ['case',
  ['boolean', ['feature-state', 'hover'], false], ['case',
    ['all', ['!=', ['get', gaugeIntProperty], null], ['>=', 1450, ['get', gaugeIntProperty]], ['<=', ['get', gaugeIntProperty], 1524]], colors.hover.alternative,
    colors.hover.main,
  ],
  // monorails or tracks with monorail gauge value
  ['any',
    ['==', ['get', 'feature'], 'monorail'],
    ['all',
      ['==', ['get', gaugeProperty], 'monorail'],
      ['any',
        ['==', ['get', 'feature'], 'rail'],
        ['==', ['get', 'feature'], 'light_rail'],
        ['==', ['get', 'feature'], 'subway'],
        ['==', ['get', 'feature'], 'tram'],
      ],
    ],
  ], color_gauge_monorail,
  // other tracks with inaccurate gauge value
  ['all',
    ['==', ['get', gaugeProperty], 'standard'],
    ['any',
      ['==', ['get', 'feature'], 'rail'],
      ['==', ['get', 'feature'], 'light_rail'],
      ['==', ['get', 'feature'], 'subway'],
      ['==', ['get', 'feature'], 'tram'],
    ],
  ], color_gauge_standard,
  ['all',
    ['==', ['get', gaugeProperty], 'broad'],
    ['any',
      ['==', ['get', 'feature'], 'rail'],
      ['==', ['get', 'feature'], 'light_rail'],
      ['==', ['get', 'feature'], 'subway'],
      ['==', ['get', 'feature'], 'tram'],
    ],
  ], color_gauge_broad,
  ['any',
    ['all',
      ['==', ['get', gaugeProperty], 'narrow'],
      ['any',
        ['==', ['get', 'feature'], 'rail'],
        ['==', ['get', 'feature'], 'light_rail'],
        ['==', ['get', 'feature'], 'subway'],
        ['==', ['get', 'feature'], 'tram'],
      ],
    ],
    ['all',
      ['==', ['get', 'feature'], 'narrow_gauge'],
      ['any',
        ['==', ['get', gaugeProperty], 'narrow'],
        ['==', ['get', gaugeProperty], 'broad'],
        ['==', ['get', gaugeProperty], 'standard'],
        ['==', ['get', gaugeProperty], 'unknown'],
        ['==', ['get', gaugeProperty], null],
      ],
    ],
  ], color_gauge_narrow,
  // miniature tracks with inaccurate gauge value
  ['all',
    ['==', ['get', 'feature'], 'miniature'],
    ['any',
      ['==', ['get', gaugeProperty], 'narrow'],
      ['==', ['get', gaugeProperty], 'broad'],
      ['==', ['get', gaugeProperty], 'standard'],
      ['==', ['get', gaugeProperty], 'unknown'],
      ['==', ['get', gaugeProperty], null],
    ],
  ], color_gauge_miniature,
  // unknown high numeric gauge values
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>=', ['get', gaugeIntProperty], 3000]], color_gauge_unknown,
  // colors for numeric gauge values
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 88, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 63]], color_gauge_0064,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 127, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 88]], color_gauge_0089,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 184, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 127]], color_gauge_0127,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 190, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 184]], color_gauge_0184,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 260, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 190]], color_gauge_0190,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 380, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 260]], color_gauge_0260,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 500, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 380]], color_gauge_0381,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 597, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 500]], color_gauge_0500,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 600, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 597]], color_gauge_0597,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 609, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 600]], color_gauge_0600,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 700, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 609]], color_gauge_0610,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 750, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 700]], color_gauge_0700,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 760, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 750]], color_gauge_0750,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 762, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 760]], color_gauge_0760,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 785, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 762]], color_gauge_0762,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 800, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 785]], color_gauge_0785,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 891, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 800]], color_gauge_0800,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 900, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 891]], color_gauge_0891,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 914, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 900]], color_gauge_0900,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 950, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 914]], color_gauge_0914,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1000, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 950]], color_gauge_0950,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1009, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1000]], color_gauge_1000,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1050, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1009]], color_gauge_1009,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1066, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1050]], color_gauge_1050,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1100, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1066]], color_gauge_1067,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1200, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1100]], color_gauge_1100,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1372, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1200]], color_gauge_1200,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1422, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1372]], color_gauge_1372,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1432, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1422]], color_gauge_1422,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1435, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1432]], color_gauge_1432,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1440, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1435]], color_gauge_1435,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1445, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1440]], color_gauge_1440,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1450, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1445]], color_gauge_1445,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1458, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1450]], color_gauge_1450,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1495, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1458]], color_gauge_1458,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1520, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1495]], color_gauge_1495,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1522, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1520]], color_gauge_1520,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1524, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1522]], color_gauge_1522,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1581, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1524]], color_gauge_1524,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1588, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1581]], color_gauge_1581,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1600, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1588]], color_gauge_1588,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1668, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1600]], color_gauge_1600,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1672, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1668]], color_gauge_1668,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1700, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1672]], color_gauge_1676,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1800, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1700]], color_gauge_1700,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 1880, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1800]], color_gauge_1800,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 2000, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 1880]], color_gauge_1880,
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 3000, ['get', gaugeIntProperty]], ['>=', ['get', gaugeIntProperty], 2000]], color_gauge_2000,
  // color for unknown low numeric gauge values
  ['all', ['!=', ['get', gaugeIntProperty], null], ['>', 63, ['get', gaugeIntProperty]], ['>', ['get', gaugeIntProperty], 0]], color_gauge_unknown,
  'gray',
];

const loadingGaugeFillColor = ['match', ['get', 'loading_gauge'],
  ...loading_gauges.loading_gauges.flatMap(loading_gauge =>
    [loading_gauge.value, loading_gauge.color]
  ),
  'gray',
];
const trackClassFillColor = ['match', ['get', 'track_class'],
  ...track_classes.track_classes.flatMap(track_class =>
    [track_class.value, track_class.color]
  ),
  'gray',
];

const sources = {
  search: {
    type: 'geojson',
    data: {
      type: 'FeatureCollection',
      features: [],
    },
  },
  standard_railway_line_low: {
    type: 'vector',
    url: '/standard_railway_line_low',
  },
  speed_railway_line_low: {
    type: 'vector',
    url: '/speed_railway_line_low',
  },
  signals_railway_line_low: {
    type: 'vector',
    url: '/signals_railway_line_low',
  },
  electrification_railway_line_low: {
    type: 'vector',
    url: '/electrification_railway_line_low',
  },
  gauge_railway_line_low: {
    type: 'vector',
    url: '/gauge_railway_line_low',
  },
  loading_gauge_railway_line_low: {
    type: 'vector',
    url: '/loading_gauge_railway_line_low',
  },
  track_class_railway_line_low: {
    type: 'vector',
    url: '/track_class_railway_line_low',
  },
  operator_railway_line_low: {
    type: 'vector',
    url: '/operator_railway_line_low',
  },
  openrailwaymap_low: {
    type: 'vector',
    url: '/railway_line_high',
  },
  standard_railway_text_stations_low: {
    type: 'vector',
    url: '/standard_railway_text_stations_low',
    metadata: {
      supports: ['language'],
    },
  },
  standard_railway_text_stations_med: {
    type: 'vector',
    url: '/standard_railway_text_stations_med',
    metadata: {
      supports: ['language'],
    },
  },
  high: {
    type: 'vector',
    url: '/railway_line_high,railway_text_km',
  },
  openrailwaymap_standard: {
    type: 'vector',
    url: '/standard_railway_turntables,standard_railway_text_stations,standard_railway_grouped_stations,standard_railway_grouped_station_areas,standard_railway_symbols,standard_railway_switch_ref,standard_station_entrances,standard_railway_platforms,standard_railway_platform_edges,standard_railway_stop_positions',
    metadata: {
      supports: ['language'],
    },
  },
  openrailwaymap_speed: {
    type: 'vector',
    url: '/speed_railway_signals',
  },
  openrailwaymap_signals: {
    type: 'vector',
    url: '/signals_railway_signals,signals_signal_boxes',
  },
  openrailwaymap_electrification: {
    type: 'vector',
    url: '/electrification_signals,electrification_catenary,electrification_railway_symbols,electrification_substation',
  },
  openrailwaymap_operator: {
    type: 'vector',
    url: '/operator_railway_symbols',
  },
  openhistoricalmap: {
    type: 'vector',
    tiles: ['https://vtiles.openhistoricalmap.org/maps/osm/{z}/{x}/{y}.pbf'],
    attribution: '<a target="_blank" href="https://www.openhistoricalmap.org/">OpenHistoricalMap</a>',
  },
  dem: {
    type: 'raster-dem',
    tiles: [
      // See https://registry.opendata.aws/terrain-tiles/
      'https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'
    ],
    attribution: '<a target="_blank" href="https://registry.opendata.aws/terrain-tiles/">Mapzen Terrain</a>',
    encoding: 'terrarium',
    tileSize: 256,
    maxzoom: 15,
  },
};

const searchResults = {
  id: 'search',
  type: 'circle',
  source: 'search',
  paint: {
    'circle-radius': 8,
    'circle-color': 'rgba(183, 255, 0, 0.7)',
    'circle-stroke-width': 2,
    'circle-stroke-color': 'black',
  },
};

const railwayLine = (text, layers) => [

  // Tunnels

  ...layers.flatMap(({id, minzoom, maxzoom, source, sourceLayer, filter, width, states, sort}) =>
    Object.entries(states).map(([state, dash]) => ({
      id: `${id}_tunnel_casing_${state}`,
      type: 'line',
      minzoom,
      maxzoom,
      source,
      'source-layer': sourceLayer || 'railway_line_high',
      filter: ['all',
        ['==', ['get', 'state'], state],
        ['==', ['get', 'tunnel'], true],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          state === 'construction' ? ['global-state', 'showConstructionInfrastructure']
            : state === 'proposed' ? ['global-state', 'showProposedInfrastructure']
              : state === 'abandoned' ? ['global-state', 'showAbandonedInfrastructure']
                : state === 'razed' ? ['global-state', 'showRazedInfrastructure']
                  : true, 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': dash ? 'butt' : 'round',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': colors.casing,
        'line-width': width,
        'line-gap-width': railway_casing_add,
        'line-dasharray': dash ?? undefined,
      },
    }))
  ),
  ...layers.flatMap(({id, minzoom, maxzoom, source, sourceLayer, filter, width, color, hoverColor, states, sort}) => [
    ...Object.entries(states).map(([state, dash]) => ({
      id: `${id}_tunnel_fill_${state}`,
      type: 'line',
      minzoom,
      maxzoom,
      source,
      'source-layer': sourceLayer || 'railway_line_high',
      filter: ['all',
        ['==', ['get', 'state'], state],
        ['==', ['get', 'tunnel'], true],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          state === 'construction' ? ['global-state', 'showConstructionInfrastructure']
            : state === 'proposed' ? ['global-state', 'showProposedInfrastructure']
              : state === 'abandoned' ? ['global-state', 'showAbandonedInfrastructure']
                : state === 'razed' ? ['global-state', 'showRazedInfrastructure']
                  : true, 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': dash ? 'butt' : 'round',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], hoverColor || colors.hover.main,
          color,
        ],
        'line-width': width,
        'line-dasharray': dash ?? undefined,
      },
    })),
  ]),
  ...layers.flatMap(({id, minzoom, maxzoom, source, sourceLayer, filter, width, states, sort}) => ({
    id: `${id}_tunnel_cover`,
    type: 'line',
    minzoom: Math.max(minzoom, 8),
    maxzoom,
    source,
    'source-layer': sourceLayer || 'railway_line_high',
    filter: ['all',
      ['any', ...Object.keys(states).map(state =>
        state === 'construction' ? ['all', ['global-state', 'showConstructionInfrastructure'], ['==', ['get', 'state'], state]]
          : state === 'proposed' ? ['all', ['global-state', 'showProposedInfrastructure'], ['==', ['get', 'state'], state]]
          : state === 'abandoned' ? ['all', ['global-state', 'showAbandonedInfrastructure'], ['==', ['get', 'state'], state]]
          : state === 'razed' ? ['all', ['global-state', 'showRazedInfrastructure'], ['==', ['get', 'state'], state]]
          : ['==', ['get', 'state'], state])
      ],
      ['==', ['get', 'tunnel'], true],
      filter ?? true,
    ].filter(it => it !== true),
    layout: {
      'visibility': ['case',
        ['<', ['global-state', 'date'], defaultDate], 'none',
        'visible',
      ],
      'line-join': 'round',
      'line-cap': 'butt',
      'line-sort-key': sort,
    },
    paint: {
      'line-color': colors.styles.standard.tunnelCover,
      'line-width': width,
    },
  })),
  ...layers.flatMap(({id, filter, color, states}) =>
    preferredDirectionLayer(`${id}_tunnel_preferred_direction`,
      ['all',
        ['==', ['get', 'tunnel'], true],
        ['any', ...Object.keys(states).map(state =>
          state === 'construction' ? ['all', ['global-state', 'showConstructionInfrastructure'], ['==', ['get', 'state'], state]]
            : state === 'proposed' ? ['all', ['global-state', 'showProposedInfrastructure'], ['==', ['get', 'state'], state]]
            : state === 'abandoned' ? ['all', ['global-state', 'showAbandonedInfrastructure'], ['==', ['get', 'state'], state]]
            : state === 'razed' ? ['all', ['global-state', 'showRazedInfrastructure'], ['==', ['get', 'state'], state]]
            : ['==', ['get', 'state'], state])
        ],
        ['any',
          ['==', ['get', 'preferred_direction'], 'forward'],
          ['==', ['get', 'preferred_direction'], 'backward'],
          ['==', ['get', 'preferred_direction'], 'both'],
        ],
        filter ?? true,
      ].filter(it => it !== true),
      color,
    ),
  ),

  // Ground

  ...layers.flatMap(({id, minzoom, maxzoom, source, sourceLayer, filter, width, states, sort}) =>
    Object.entries(states).map(([state, dash]) => ({
      id: `${id}_casing_${state}`,
      type: 'line',
      minzoom,
      maxzoom,
      source,
      'source-layer': sourceLayer || 'railway_line_high',
      filter: ['all',
        ['==', ['get', 'state'], state],
        ['!=', ['==', ['get', 'bridge'], true], true],
        ['!=', ['get', 'tunnel'], true],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          state === 'construction' ? ['global-state', 'showConstructionInfrastructure']
            : state === 'proposed' ? ['global-state', 'showProposedInfrastructure']
              : state === 'abandoned' ? ['global-state', 'showAbandonedInfrastructure']
                : state === 'razed' ? ['global-state', 'showAbandonedInfrastructure']
                  : true, 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': 'butt',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': colors.casing,
        'line-width': width,
        'line-gap-width': railway_casing_add,
        'line-dasharray': dash ?? undefined,
      },
    }))
  ),
  ...layers.flatMap(({id, minzoom, maxzoom, source, sourceLayer, filter, width, color, hoverColor, states, sort}) => [
    ...Object.entries(states).map(([state, dash]) => ({
      id: `${id}_fill_${state}`,
      type: 'line',
      minzoom,
      maxzoom,
      source,
      'source-layer': sourceLayer || 'railway_line_high',
      filter: ['all',
        ['==', ['get', 'state'], state],
        ['!=', ['==', ['get', 'bridge'], true], true],
        ['!=', ['get', 'tunnel'], true],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          state === 'construction' ? ['global-state', 'showConstructionInfrastructure']
            : state === 'proposed' ? ['global-state', 'showProposedInfrastructure']
              : state === 'abandoned' ? ['global-state', 'showAbandonedInfrastructure']
                : state === 'razed' ? ['global-state', 'showRazedInfrastructure']
                  : true, 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': dash ? 'butt' : 'round',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], hoverColor || colors.hover.main,
          color,
        ],
        'line-width': width,
        'line-dasharray': dash ?? undefined,
      },
    })),
  ]),

  // Bridges

  ...layers
    .filter(({states}) => 'present' in states)
    .flatMap(({id, minzoom, maxzoom, source, sourceLayer, filter, width, sort}) => [
      {
        id: `${id}_bridge_railing`,
        type: 'line',
        minzoom: Math.max(minzoom, 8),
        maxzoom,
        source,
        'source-layer': sourceLayer || 'railway_line_high',
        filter: ['all',
          ['==', ['get', 'state'], 'present'],
          ['==', ['get', 'bridge'], true],
          ['>=',
            ['get', 'way_length'],
            ['interpolate', ["exponential", .5], ['zoom'],
              8, 1500,
              16, 0
            ],
          ],
          filter ?? true,
        ].filter(it => it !== true),
        layout: {
          'visibility': ['case',
            ['<', ['global-state', 'date'], defaultDate], 'none',
            'visible',
          ],
          'line-join': 'round',
          'line-cap': 'butt',
          'line-sort-key': sort,
        },
        paint: {
          'line-color': colors.styles.standard.casing.bridge,
          'line-width': width,
          'line-gap-width': bridge_casing_add,
        }
      },
      {
        id: `${id}_bridge_casing`,
        type: 'line',
        minzoom: Math.max(minzoom, 8),
        maxzoom,
        source,
        'source-layer': sourceLayer || 'railway_line_high',
        filter: ['all',
          ['==', ['get', 'state'], 'present'],
          ['==', ['get', 'bridge'], true],
          ['>=',
            ['get', 'way_length'],
            ['interpolate', ["exponential", .5], ['zoom'],
              8, 1500,
              16, 0
            ],
          ],
          filter ?? true,
        ].filter(it => it !== true),
        layout: {
          'visibility': ['case',
            ['<', ['global-state', 'date'], defaultDate], 'none',
            'visible',
          ],
          'line-join': 'round',
          'line-cap': 'butt',
          'line-sort-key': sort,
        },
        paint: {
          'line-color': colors.casing,
          'line-width': width,
          'line-gap-width': railway_casing_add,
        }
      },
    ]),

  ...layers.flatMap(({id, minzoom, maxzoom, source, sourceLayer, filter, width, color, hoverColor, states, sort}) => [
    ...Object.entries(states).map(([state, dash]) => ({
      id: `${id}_bridge_fill_${state}`,
      type: 'line',
      minzoom,
      maxzoom,
      source,
      'source-layer': sourceLayer || 'railway_line_high',
      filter: ['all',
        ['==', ['get', 'state'], state],
        ['==', ['get', 'bridge'], true],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          state === 'construction' ? ['global-state', 'showConstructionInfrastructure']
            : state === 'proposed' ? ['global-state', 'showProposedInfrastructure']
              : state === 'abandoned' ? ['global-state', 'showAbandonedInfrastructure']
                : state === 'razed' ? ['global-state', 'showRazedInfrastructure']
                  : true, 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': dash ? 'butt' : 'round',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], hoverColor || colors.hover.main,
          color,
        ],
        'line-width': width,
        'line-dasharray': dash ?? undefined,
      },
    })),
  ]),

  // Preferred direction

  ...layers.flatMap(({id, filter, color, states}) =>
    preferredDirectionLayer(
      `${id}_preferred_direction`,
      ['all',
        ['any', ...Object.keys(states).map(state =>
          state === 'construction' ? ['all', ['global-state', 'showConstructionInfrastructure'], ['==', ['get', 'state'], state]]
            : state === 'proposed' ? ['all', ['global-state', 'showProposedInfrastructure'], ['==', ['get', 'state'], state]]
            : state === 'abandoned' ? ['all', ['global-state', 'showAbandonedInfrastructure'], ['==', ['get', 'state'], state]]
            : state === 'razed' ? ['all', ['global-state', 'showRazedInfrastructure'], ['==', ['get', 'state'], state]]
            : ['==', ['get', 'state'], state])
        ],
        ['!=', ['get', 'tunnel'], true],
        ['any',
          ['==', ['get', 'preferred_direction'], 'forward'],
          ['==', ['get', 'preferred_direction'], 'backward'],
          ['==', ['get', 'preferred_direction'], 'both'],
        ],
        filter ?? true,
      ].filter(it => it !== true),
      color,
    ),
  ),

  // Text layers

  railwayKmText,

  ...layers.flatMap(({id, minzoom, maxzoom, source, sourceLayer, filter, states}) => ({
    id: `${id}_text`,
    type: 'symbol',
    minzoom,
    maxzoom,
    source,
    'source-layer': sourceLayer || 'railway_line_high',
    filter: ['all',
      ['any', ...Object.keys(states).map(state =>
        state === 'construction' ? ['all', ['global-state', 'showConstructionInfrastructure'], ['==', ['get', 'state'], state]]
          : state === 'proposed' ? ['all', ['global-state', 'showProposedInfrastructure'], ['==', ['get', 'state'], state]]
          : state === 'abandoned' ? ['all', ['global-state', 'showAbandonedInfrastructure'], ['==', ['get', 'state'], state]]
          : state === 'razed' ? ['all', ['global-state', 'showRazedInfrastructure'], ['==', ['get', 'state'], state]]
          : ['==', ['get', 'state'], state])
      ],
      filter ?? true,
    ].filter(it => it !== true),
    paint: {
      'text-color': colors.railwayLine.text,
      'text-halo-color': ['case',
        ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
        colors.halo,
      ],
      'text-halo-width': 2,
    },
    layout: {
      'visibility': ['case',
        ['<', ['global-state', 'date'], defaultDate], 'none',
        'visible',
      ],
      'symbol-z-order': 'source',
      'symbol-placement': 'line',
      'text-field': text,
      'text-font': font.bold,
      'text-size': 11,
      'text-padding': 10,
      'text-max-width': 5,
      'symbol-spacing': 200,
    },
  })),
];


const historicalRailwayLine = (text, layers) => [

  // Tunnels

  ...layers.flatMap(({id, minzoom, maxzoom, filter, width, sort, dash}) => [
    {
      id: `${id}_tunnel_casing`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['==', ['get', 'tunnel'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['global-state', 'allDates'],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': 'butt',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': colors.casing,
        'line-width': width,
        'line-gap-width': railway_casing_add,
        'line-dasharray': abandoned_dasharray,
      },
    },
    {
      id: `${id}_tunnel_casing_historical`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
        ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
        ['==', ['get', 'tunnel'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['<', ['global-state', 'date'], defaultDate],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': dash ? 'butt' : 'round',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': colors.casing,
        'line-width': width,
        'line-gap-width': railway_casing_add,
        'line-dasharray': dash ?? undefined,
      },
    }
  ]),
  ...layers.flatMap(({id, minzoom, maxzoom, filter, width, color, hoverColor, sort, dash}) => [
    {
      id: `${id}_tunnel_fill`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['==', ['get', 'tunnel'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['global-state', 'allDates'],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': 'butt',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], hoverColor || colors.hover.main,
          color,
        ],
        'line-width': width,
        'line-dasharray': abandoned_dasharray,
      },
    },
    {
      id: `${id}_tunnel_fill_historical`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
        ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
        ['==', ['get', 'tunnel'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['<', ['global-state', 'date'], defaultDate],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': dash ? 'butt' : 'round',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], hoverColor || colors.hover.main,
          color,
        ],
        'line-width': width,
        'line-dasharray': dash ?? undefined,
      },
    }
  ]),
  ...layers.map(({id, minzoom, maxzoom, filter, width, sort}) => ({
    id: `${id}_tunnel_cover`,
    type: 'line',
    minzoom: Math.max(minzoom, 8),
    maxzoom,
    source: 'openhistoricalmap',
    'source-layer': 'transport_lines',
    filter: ['all',
      ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
      ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
      ['==', ['get', 'tunnel'], 1],
      filter ?? true,
    ].filter(it => it !== true),
    layout: {
      'visibility': ['case',
        ['all',
          ['!', ['global-state', 'allDates']],
          ['<', ['global-state', 'date'], defaultDate],
          ['global-state', 'openHistoricalMap'],
        ], 'visible',
        'none',
      ],
      'line-join': 'round',
      'line-cap': 'butt',
      'line-sort-key': sort,
    },
    paint: {
      'line-color': colors.styles.standard.tunnelCover,
      'line-width': width,
    },
  })),

  // Ground

  ...layers.flatMap(({id, minzoom, maxzoom, filter, width, sort, dash}) => [
    {
      id: `${id}_casing`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['!=', ['get', 'bridge'], 1],
        ['!=', ['get', 'tunnel'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['global-state', 'allDates'],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': 'butt',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': colors.casing,
        'line-width': width,
        'line-gap-width': railway_casing_add,
        'line-dasharray': abandoned_dasharray,
      },
    },
    {
      id: `${id}_casing_historical`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
        ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
        ['!=', ['get', 'bridge'], 1],
        ['!=', ['get', 'tunnel'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['<', ['global-state', 'date'], defaultDate],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': 'butt',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': colors.casing,
        'line-width': width,
        'line-gap-width': railway_casing_add,
        'line-dasharray': dash ?? undefined,
      },
    }
  ]),
  ...layers.flatMap(({id, minzoom, maxzoom, filter, width, color, hoverColor, sort, dash}) => [
    {
      id: `${id}_fill`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['!=', ['get', 'bridge'], 1],
        ['!=', ['get', 'tunnel'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['global-state', 'allDates'],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': 'butt',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], hoverColor || colors.hover.main,
          color,
        ],
        'line-width': width,
        'line-dasharray': abandoned_dasharray,
      },
    },
    {
      id: `${id}_fill_historical`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
        ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
        ['!=', ['get', 'bridge'], 1],
        ['!=', ['get', 'tunnel'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['<', ['global-state', 'date'], defaultDate],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': dash ? 'butt' : 'round',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], hoverColor || colors.hover.main,
          color,
        ],
        'line-width': width,
        'line-dasharray': dash ?? undefined,
      },
    },
  ]),

  // Bridges

  ...layers.flatMap(({id, minzoom, maxzoom, filter, width, sort}) => [
    {
      id: `${id}_bridge_railing`,
      type: 'line',
      minzoom: Math.max(minzoom, 8),
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['any',
          ['global-state', 'allDates'],
          ['all',
            ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
            ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
          ],
        ],
        ['==', ['get', 'bridge'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['any',
              ['global-state', 'allDates'],
              ['<', ['global-state', 'date'], defaultDate],
            ],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': 'butt',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': colors.styles.standard.casing.bridge,
        'line-width': width,
        'line-gap-width': bridge_casing_add,
      }
    },
    {
      id: `${id}_bridge_casing`,
      type: 'line',
      minzoom: Math.max(minzoom, 8),
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['any',
          ['global-state', 'allDates'],
          ['all',
            ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
            ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
          ],
        ],
        ['==', ['get', 'bridge'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['any',
              ['global-state', 'allDates'],
              ['<', ['global-state', 'date'], defaultDate],
            ],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': 'butt',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': colors.casing,
        'line-width': width,
        'line-gap-width': railway_casing_add,
      }
    },
  ]),

  ...layers.flatMap(({id, minzoom, maxzoom, filter, width, color, hoverColor, sort, dash}) => [
    {
      id: `${id}_bridge_fill`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['==', ['get', 'bridge'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['global-state', 'allDates'],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': 'butt',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], hoverColor || colors.hover.main,
          color,
        ],
        'line-width': width,
        'line-dasharray': abandoned_dasharray,
      },
    },
    {
      id: `${id}_bridge_fill_historical`,
      type: 'line',
      minzoom,
      maxzoom,
      source: 'openhistoricalmap',
      'source-layer': 'transport_lines',
      filter: ['all',
        ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
        ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
        ['==', ['get', 'bridge'], 1],
        filter ?? true,
      ].filter(it => it !== true),
      layout: {
        'visibility': ['case',
          ['all',
            ['<', ['global-state', 'date'], defaultDate],
            ['global-state', 'openHistoricalMap'],
          ], 'visible',
          'none',
        ],
        'line-join': 'round',
        'line-cap': dash ? 'butt' : 'round',
        'line-sort-key': sort,
      },
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], hoverColor || colors.hover.main,
          color,
        ],
        'line-width': width,
        'line-dasharray': dash ?? undefined,
      },
    }
  ]),

  // Text layers

  ...layers.flatMap(({id, minzoom, maxzoom, filter}) => ({
    id: `${id}_text`,
    type: 'symbol',
    minzoom,
    maxzoom,
    source: 'openhistoricalmap',
    'source-layer': 'transport_lines',
    filter: ['all',
      ['any',
        ['global-state', 'allDates'],
        ['all',
          ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
          ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
        ],
      ],
      filter ?? true,
    ].filter(it => it !== true),
    paint: {
      'text-color': colors.railwayLine.text,
      'text-halo-color': ['case',
        ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
        colors.halo,
      ],
      'text-halo-width': 2,
    },
    layout: {
      'visibility': ['case',
        ['all',
          ['any',
            ['global-state', 'allDates'],
            ['<', ['global-state', 'date'], defaultDate],
          ],
          ['global-state', 'openHistoricalMap'],
        ], 'visible',
        'none',
      ],
      'symbol-z-order': 'source',
      'symbol-placement': 'line',
      'text-field': text,
      'text-font': font.bold,
      'text-size': 11,
      'text-padding': 10,
      'text-max-width': 5,
      'symbol-spacing': 400,
    },
  })),
];

const railwayKmText = {
  id: 'railway_text_km',
  type: 'symbol',
  minzoom: 10,
  source: 'high',
  'source-layer': 'railway_text_km',
  filter: ['step', ['zoom'],
    ['get', 'zero'],
    13,
    true,
  ],
  paint: {
    'text-color': colors.km.text,
    'text-halo-color': ['case',
      ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
      colors.halo,
    ],
    'text-halo-width': 1,
  },
  layout: {
    'visibility': ['case',
      ['<', ['global-state', 'date'], defaultDate], 'none',
      'visible',
    ],
    'symbol-z-order': 'source',
    'text-field': ['step', ['zoom'],
      ['get', 'pos_int'],
      13,
      ['get', 'pos'],
    ],
    'text-font': ['Fira Code Bold'],
    'text-size': 11,
  },
};

const preferredDirectionLayer = (id, filter, color) => ({
  id,
  type: 'symbol',
  minzoom: 15,
  source: 'high',
  'source-layer': 'railway_line_high',
  filter,
  paint: {
    'icon-color': ['case',
      ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
      color,
    ],
    'icon-halo-color': ['case',
      ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
      colors.halo,
    ],
    'icon-halo-width': 2.0,
  },
  layout: {
    'visibility': ['case',
      ['<', ['global-state', 'date'], defaultDate], 'none',
      'visible',
    ],
    'symbol-placement': 'line',
    'symbol-spacing': 750,
    'icon-overlap': 'always',
    'icon-image': ['match', ['get', 'preferred_direction'],
      'forward', 'sdf:general/line-direction',
      'backward', 'sdf:general/line-direction',
      'both', 'sdf:general/line-direction-both',
      '',
    ],
    'icon-rotate': ['match', ['get', 'preferred_direction'],
      'backward', 180,
      0,
    ],
  },
});

const imageLayerWithOutline = (id, spriteExpression, layer) => [
  {
    id: `${id}_outline`,
    ...layer,
    paint: {
      'icon-halo-color': ['case',
        ['boolean', ['feature-state', 'hover'], false], colors.hover.iconHalo,
        colors.iconHalo,
      ],
      'icon-halo-blur': ['case',
        ['boolean', ['feature-state', 'hover'], false], 1.0,
        0.0,
      ],
      'icon-halo-width': ['case',
        ['boolean', ['feature-state', 'hover'], false], 3.0,
        2.0,
      ],
    },
    layout: {
      ...(layer.layout || {}),
      'visibility': ['case',
        ['<', ['global-state', 'date'], defaultDate], 'none',
        'visible',
      ],
      'icon-image': ['image', ['concat', 'sdf:', spriteExpression]],
    },
  },
  {
    id: `${id}_image`,
    ...layer,
    layout: {
      ...(layer.layout || {}),
      'visibility': ['case',
        ['<', ['global-state', 'date'], defaultDate], 'none',
        'visible',
      ],
      'icon-image': ['image', spriteExpression],
    },
  },
]

const hillshade = {
  id: 'hillshade',
  type: 'hillshade',
  source: 'dem',
  paint: {
    'hillshade-method': 'combined',
    'hillshade-exaggeration': ['interpolate', ['linear'], ['zoom'],
      8, 0.2,
      12, 0.4,
      15, 0.8,
    ],
  },
  layout: {
    visibility: ['case',
      ['global-state', 'hillshade'], 'visible',
      'none',
    ],
  }
}

/**
 * Strategy for displaying railway lines
 *
 * Variables:
 * - state
 * - feature
 * - usage
 * - service
 *
 * Display tools, configurable per zoom level
 * - show/not show
 * - line width
 * - line color
 * - line dashes
 */
const layers = {

  /**
   * Date support:
   * - When the global state 'allDates' is true, both historical and present data is shown
   * - When the global state 'allDates' is false, and the global state 'date' is less than the default date, only historical data is shown
   * - When the global state 'allDates' is false, and the global state 'date' is equal to the default date, only present data is shown
   */
  standard: [
    hillshade,
    {
      id: 'railway_grouped_station_areas',
      type: 'line',
      minzoom: 13,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_grouped_station_areas',
      paint: {
        'line-color': colors.styles.standard.stationAreaGroup,
        'line-width': 2,
        'line-dasharray': [4, 4],
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
      },
    },
    {
      id: 'railway_grouped_stations',
      type: 'fill',
      minzoom: 13,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_grouped_stations',
      filter: ['all',
        ['!=', ['get', 'feature'], 'yard'], // Yards only have an outline
        ['match', ['get', 'state'],
          'construction', ['global-state', 'showConstructionInfrastructure'],
          'proposed', ['global-state', 'showProposedInfrastructure'],
          'abandoned', ['global-state', 'showAbandonedInfrastructure'],
          'razed', ['global-state', 'showRazedInfrastructure'],
          true,
        ],
      ],
      paint: {
        'fill-color': ['case',
          ['in', ['get', 'state'], ['literal', ['disused', 'abandoned', 'preserved', 'razed']]], colors.styles.standard.past,
          ['in', ['get', 'state'], ['literal', ['construction', 'proposed']]], colors.styles.standard.future,
          ['==', ['get', 'station'], 'light_rail'], colors.styles.standard.light_rail,
          ['==', ['get', 'station'], 'subway'], colors.styles.standard.subway,
          ['==', ['get', 'station'], 'monorail'], colors.styles.standard.monorail,
          ['==', ['get', 'station'], 'miniature'], colors.styles.standard.miniature,
          ['==', ['get', 'station'], 'funicular'], colors.styles.standard.funicular,
          ['==', ['get', 'station'], 'tram'], colors.styles.standard.tram,
          colors.styles.standard.main,
        ],
        'fill-opacity': ['case',
          ['boolean', ['feature-state', 'hover'], false], 0.3,
          0.2,
        ],
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
      },
    },
    ...Object.entries({
      present: present_dasharray,
      disused: disused_dasharray,
      abandoned: abandoned_dasharray,
      preserved: disused_dasharray,
      construction: construction_dasharray,
      proposed: proposed_dasharray,
    }).map(([state, dasharray]) => ({
      id: `railway_grouped_stations_outline_${state}`,
      type: 'line',
      minzoom: 13,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_grouped_stations',
      filter: ['==', ['get', 'state'], state],
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          ['==', ['get', 'feature'], 'yard'], colors.styles.standard.yardText,
          // Use outline color of feature, without taking state into account
          ['==', ['get', 'station'], 'light_rail'], colors.styles.standard.light_rail,
          ['==', ['get', 'station'], 'subway'], colors.styles.standard.subway,
          ['==', ['get', 'station'], 'monorail'], colors.styles.standard.monorail,
          ['==', ['get', 'station'], 'miniature'], colors.styles.standard.miniature,
          ['==', ['get', 'station'], 'funicular'], colors.styles.standard.funicular,
          ['==', ['get', 'station'], 'tram'], colors.styles.standard.tram,
          colors.styles.standard.main,
        ],
        'line-opacity': ['match', ['get', 'feature'],
          'yard', 0.2,
          0.3,
        ],
        'line-width': ['match', ['get', 'feature'],
          'yard', 6,
          2,
        ],
        'line-dasharray': dasharray,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          state === 'construction' ? ['global-state', 'showConstructionInfrastructure']
            : state === 'proposed' ? ['global-state', 'showProposedInfrastructure']
              : state === 'abandoned' ? ['global-state', 'showAbandonedInfrastructure']
                : state === 'razed' ? ['global-state', 'showRazedInfrastructure']
                  : true, 'visible',
          'none',
        ],
      }
    })),
    ...historicalRailwayLine(
      ['step', ['zoom'],
        ['coalesce', ['get', 'ref'], ''],
        11,
        ['coalesce', ['get', 'name'], ''],
      ],
      [
        {
          id: 'railway_line_historical_miniature',
          minzoom: 12,
          filter: ['==', ['get', 'type'], 'miniature'],
          color: colors.styles.standard.miniature,
          width: 2,
        },
        {
          id: 'railway_line_historical_funicular',
          minzoom: 12,
          filter: ['==', ['get', 'type'], 'funicular'],
          color: colors.styles.standard.funicular,
          width: 2,
        },
        {
          id: 'railway_line_historical_disused',
          minzoom: 11,
          filter: ['==', ['get', 'type'], 'disused'],
          color: colors.styles.standard.disused,
          dash: disused_dasharray,
          width: 1.5,
        },
        {
          id: 'railway_line_historical_abandoned',
          minzoom: 11,
          filter: ['==', ['get', 'type'], 'abandoned'],
          color: colors.styles.standard.abandoned,
          dash: abandoned_dasharray,
          width: 1.5,
        },
        {
          id: 'railway_line_historical_construction',
          minzoom: 10,
          filter: ['==', ['get', 'type'], 'construction'],
          color: colors.styles.standard.main,
          dash: construction_dasharray,
          width: 1.5,
          visibility: ['global-state', 'showConstructionInfrastructure'],
        },
        {
          id: 'railway_line_historical_proposed',
          minzoom: 10,
          filter: ['==', ['get', 'type'], 'proposed'],
          color: colors.styles.standard.main,
          dash: proposed_dasharray,
          width: 1.5,
          visibility: ['global-state', 'showProposedInfrastructure'],
        },
        {
          id: 'railway_line_historical_narrow_gauge',
          minzoom: 10,
          filter: ['all',
            ['==', ['get', 'type'], 'narrow_gauge'],
            ['!',
              // Covered by industrial case
              ['==', ['get', 'usage'], 'industrial'],
            ],
          ],
          color: colors.styles.standard.narrowGauge,
          width: 2,
        },
        {
          id: 'railway_line_historical_service',
          minzoom: 10,
          filter: ['all',
            ['==', ['get', 'type'], 'rail'],
            ['==', ['get', 'usage'], null],
          ],
          color: ['match', ['get', 'service'],
            'spur', colors.styles.standard.spur,
            'siding', colors.styles.standard.siding,
            'yard', colors.styles.standard.yard,
            'crossover', colors.styles.standard.crossover,
            colors.styles.standard.unknown,
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, ['match', ['get', 'service'],
              'yard', 1,
              1.5,
            ],
            15, ['match', ['get', 'service'],
              'yard', 1,
              1.5,
            ],
            16, 2,
          ],
        },
        {
          id: 'railway_line_historical_light_rail',
          minzoom: 9,
          filter: ['any',
            ['==', ['get', 'type'], 'subway'],
            ['==', ['get', 'type'], 'tram'],
            ['==', ['get', 'type'], 'light_rail'],
            ['==', ['get', 'type'], 'monorail'],
          ],
          width: 2,
          color: ['match', ['get', 'type'],
            'light_rail', colors.styles.standard.light_rail,
            'monorail', colors.styles.standard.monorail,
            'subway', colors.styles.standard.subway,
            'tram', colors.styles.standard.tram,
            colors.styles.standard.unknown,
          ],
        },
        {
          id: 'railway_line_historical_test_military',
          minzoom: 9,
          filter: ['all',
            ['==', ['get', 'type'], 'rail'],
            ['any',
              ['==', ['get', 'usage'], 'test'],
              ['==', ['get', 'usage'], 'military'],
            ],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, 1.5,
            14, 1.5,
            16, 2,
          ],
          color: ['match', ['get', 'usage'],
            'test', colors.styles.standard.test,
            'military', colors.styles.standard.military,
            colors.styles.standard.unknown,
          ],
        },
        {
          id: 'railway_line_historical_tourism',
          minzoom: 9,
          filter: ['any',
            ['all',
              ['==', ['get', 'type'], 'rail'],
              ['==', ['get', 'usage'], 'tourism'],
            ],
            ['==', ['get', 'type'], 'preserved'],
          ],
          width: 2,
          color: colors.styles.standard.tourism,
        },
        {
          id: 'railway_line_historical_industrial',
          minzoom: 9,
          filter: ['all',
            ['==', ['get', 'usage'], 'industrial'],
            ['any',
              ['==', ['get', 'type'], 'rail'],
              ['==', ['get', 'type'], 'narrow_gauge'],
            ],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, 1.5,
            14, 1.5,
            16, 2,
          ],
          color: colors.styles.standard.industrial,
        },
        {
          id: 'railway_line_historical_branch',
          minzoom: 7,
          filter: ['all',
            ['==', ['get', 'type'], 'rail'],
            ['==', ['get', 'usage'], 'branch'],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, 2,
            14, 2,
            16, 3,
          ],
          color: colors.styles.standard.branch,
        },
        {
          id: 'railway_line_historical_main',
          minzoom: 5,
          filter: ['all',
            ['==', ['get', 'type'], 'rail'],
            ['==', ['get', 'usage'], 'main'],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, 2,
            14, 2,
            16, 3,
          ],
          color: ['case',
            ['==', ['get', 'highspeed'], 'yes'], colors.styles.standard.highspeed,
            colors.styles.standard.main,
          ],
          hoverColor: ['case',
            ['==', ['get', 'highspeed'], 'yes'], colors.hover.alternative,
            colors.hover.main,
          ],
        },
        {
          id: 'railway_line_historical_ferry',
          minzoom: 5,
          filter: ['all',
            ['==', ['get', 'type'], 'ferry'],
            ['==', ['get', 'railway'], 'ferry'],
          ],
          color: colors.styles.standard.ferry,
          width: 2,
        },
      ],
    ),
    {
      id: 'railway_platforms_polygon',
      type: 'fill',
      minzoom: 15,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_platforms',
      filter: ['any',
        ['==', ["geometry-type"], 'Polygon'],
        ['==', ["geometry-type"], 'MultiPolygon'],
      ],
      paint: {
        'fill-color': colors.styles.standard.platform,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
      },
    },
    {
      id: 'railway_platforms_polygon_outline',
      type: 'line',
      minzoom: 15,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_platforms',
      filter: ['any',
        ['==', ["geometry-type"], 'Polygon'],
        ['==', ["geometry-type"], 'MultiPolygon'],
      ],
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'line-join': 'round',
      },
      paint: {
        'line-width': 2,
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          colors.styles.standard.platform,
        ],
      },
    },
    {
      id: 'railway_platforms_line',
      type: 'line',
      minzoom: 15,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_platforms',
      filter: ['==', ["geometry-type"], 'LineString'],
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          colors.styles.standard.platform,
        ],
        'line-width': ['interpolate', ['linear'], ['zoom'],
          15, 2,
          18, 6,
          20, 10,
        ],
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
      },
    },
    {
      id: 'railway_platforms_edges',
      type: 'line',
      minzoom: 17,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_platform_edges',
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'line-join': 'round',
      },
      paint: {
        'line-width': 3,
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          colors.styles.standard.track.halo,
        ],
      },
    },
    ...railwayLine(
      ['step', ['zoom'],
        ['coalesce', ['get', 'ref'], ''],
        14,
        ['coalesce', ['get', 'standard_label'], ''],
      ],
      [
        {
          id: 'railway_line_main_low',
          minzoom: 0,
          maxzoom: 7,
          source: 'standard_railway_line_low',
          sourceLayer: 'standard_railway_line_low',
          states: {
            present: undefined,
          },
          filter: ['==', ['get', 'feature'], 'rail'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: ['case',
            ['get', 'highspeed'], colors.styles.standard.highspeed,
            colors.styles.standard.main,
          ],
          hoverColor: ['case',
            ['get', 'highspeed'], colors.hover.alternative,
            colors.hover.main,
          ],
        },
        {
          id: 'railway_ferry_main_low',
          minzoom: 0,
          maxzoom: 7,
          source: 'standard_railway_line_low',
          sourceLayer: 'standard_railway_line_low',
          states: {
            present: undefined,
          },
          filter: ['==', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: colors.styles.standard.ferry,
          hoverColor: colors.hover.main,
        },

        // Medium zooms
        // ensure that width interpolation matches low zooms

        {
          id: 'railway_line_main_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['all',
            ['==', ['get', 'feature'], 'rail'],
            ['==', ['get', 'usage'], 'main'],
          ],
          width: 2,
          color: ['case',
            ['get', 'highspeed'], colors.styles.standard.highspeed,
            colors.styles.standard.main,
          ],
          hoverColor: ['case',
            ['get', 'highspeed'], colors.hover.alternative,
            colors.hover.main,
          ],
        },
        {
          id: 'railway_line_branch_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['all',
            ['==', ['get', 'feature'], 'rail'],
            ['==', ['get', 'usage'], 'branch'],
          ],
          width: 2,
          color: colors.styles.standard.branch,
        },
        {
          id: 'railway_ferry_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['==', ['get', 'feature'], 'ferry'],
          width: 2,
          color: colors.styles.standard.ferry,
        },

        // High zooms
        // ensure that width interpolation matches medium zooms
        {
          id: 'railway_line_razed',
          minzoom: 12,
          source: 'high',
          states: {
            razed: razed_dasharray,
          },
          filter: ['==', ['get', 'state'], 'razed'],
          width: 2,
          color: colors.styles.standard.razed,
        },
        {
          id: 'railway_line_abandoned',
          minzoom: 12,
          source: 'high',
          states: {
            abandoned: abandoned_dasharray,
          },
          filter: ['==', ['get', 'state'], 'abandoned'],
          width: 2,
          color: colors.styles.standard.abandoned,
        },
        {
          id: 'railway_line_miniature',
          minzoom: 12,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['==', ['get', 'feature'], 'miniature'],
          width: 2,
          color: colors.styles.standard.miniature,
        },
        {
          id: 'railway_line_funicular',
          minzoom: 12,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['==', ['get', 'feature'], 'funicular'],
          width: 2,
          color: colors.styles.standard.funicular,
        },
        {
          id: 'railway_line_disused',
          minzoom: 11,
          source: 'high',
          states: {
            disused: disused_dasharray,
          },
          width: 1.5,
          color: colors.styles.standard.disused,
        },
        {
          id: 'railway_line_narrow_gauge',
          minzoom: 10,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['all',
            ['==', ['get', 'feature'], 'narrow_gauge'],
            ['!',
              // Covered by industrial case
              ['==', ['get', 'usage'], 'industrial'],
            ],
          ],
          width: 2,
          color: colors.styles.standard.narrowGauge,
        },
        {
          id: 'railway_line_service',
          minzoom: 10,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['all',
            ['==', ['get', 'feature'], 'rail'],
            ['==', ['get', 'usage'], null],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, ['match', ['get', 'service'],
              'yard', 1,
              1.5,
            ],
            15, ['match', ['get', 'service'],
              'yard', 1,
              1.5,
            ],
            16, 2,
          ],
          color: ['match', ['get', 'service'],
            'spur', colors.styles.standard.spur,
            'siding', colors.styles.standard.siding,
            'yard', colors.styles.standard.yard,
            'crossover', colors.styles.standard.crossover,
            colors.styles.standard.unknown,
          ],
        },
        {
          id: 'railway_line_light_rail',
          minzoom: 9,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['any',
            ['==', ['get', 'feature'], 'subway'],
            ['==', ['get', 'feature'], 'tram'],
            ['==', ['get', 'feature'], 'light_rail'],
            ['==', ['get', 'feature'], 'monorail'],
          ],
          width: 2,
          color: ['match', ['get', 'feature'],
            'light_rail', colors.styles.standard.light_rail,
            'monorail', colors.styles.standard.monorail,
            'subway', colors.styles.standard.subway,
            'tram', colors.styles.standard.tram,
            colors.styles.standard.unknown,
          ],
        },
        {
          id: 'railway_line_test_military',
          minzoom: 9,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['all',
            ['==', ['get', 'feature'], 'rail'],
            ['any',
              ['==', ['get', 'usage'], 'test'],
              ['==', ['get', 'usage'], 'military'],
            ],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, 1.5,
            14, 1.5,
            16, 2,
          ],
          color: ['match', ['get', 'usage'],
            'test', colors.styles.standard.test,
            'military', colors.styles.standard.military,
            colors.styles.standard.unknown,
          ],
        },
        {
          id: 'railway_line_tourism',
          minzoom: 9,
          source: 'high',
          states: {
            present: undefined,
            preserved: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['any',
            ['==', ['get', 'usage'], 'tourism'],
            ['==', ['get', 'state'], 'preserved'],
          ],
          width: 2,
          color: colors.styles.standard.tourism,
        },
        {
          id: 'railway_line_industrial',
          minzoom: 9,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['all',
            ['==', ['get', 'usage'], 'industrial'],
            ['any',
              ['==', ['get', 'feature'], 'rail'],
              ['==', ['get', 'feature'], 'narrow_gauge'],
            ],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, 1.5,
            14, 1.5,
            16, 2,
          ],
          color: colors.styles.standard.industrial,
        },
        {
          id: 'railway_ferry_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['==', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, 2,
            14, 2,
            16, 3,
          ],
          color: colors.styles.standard.ferry,
        },
        {
          id: 'railway_line_branch_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['all',
            ['==', ['get', 'feature'], 'rail'],
            ['==', ['get', 'usage'], 'branch'],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, 2,
            14, 2,
            16, 3,
          ],
          color: colors.styles.standard.branch,
        },
        {
          id: 'railway_line_main_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['all',
            ['==', ['get', 'feature'], 'rail'],
            ['==', ['get', 'usage'], 'main'],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            8, 2,
            14, 2,
            16, 3,
          ],
          color: ['case',
            ['get', 'highspeed'], colors.styles.standard.highspeed,
            colors.styles.standard.main,
          ],
          hoverColor: ['case',
            ['get', 'highspeed'], colors.hover.alternative,
            colors.hover.main,
          ],
        },
      ],
    ),
    {
      id: 'railway_text_stations_low1',
      type: 'symbol',
      minzoom: 4,
      maxzoom: 5,
      source: 'standard_railway_text_stations_low',
      'source-layer': 'standard_railway_text_stations_low',
      paint: {
        'icon-color': colors.styles.standard.stationsText,
        'icon-halo-width': 1,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'symbol-z-order': 'source',
        'icon-image': 'sdf:general/station-small',
        'icon-overlap': 'always',
      },
    },
    {
      id: 'railway_text_stations_low2',
      type: 'symbol',
      minzoom: 5,
      maxzoom: 7,
      source: 'standard_railway_text_stations_low',
      'source-layer': 'standard_railway_text_stations_low',
      paint: {
        'text-color': colors.styles.standard.stationsText,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
        'icon-color': colors.styles.standard.stationsText,
        'icon-halo-width': 1.5,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'symbol-z-order': 'source',
        'icon-image': ['image', ['concat', 'sdf:general/station-', ['get', 'station_size']]],
        'icon-overlap': 'always',
        'text-field': ['match', ['global-state', 'stationLowZoomLabel'],
          'label', ['get', 'label'],
          'name', ['get', 'localized_name'],
          '',
        ],
        'text-font': font.bold,
        'text-size': 11,
        'text-padding': 10,
        'text-max-width': 8,
        'text-optional': true,
        'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
      },
    },
    {
      id: 'railway_text_stations_med',
      type: 'symbol',
      minzoom: 7,
      maxzoom: 8,
      source: 'standard_railway_text_stations_med',
      'source-layer': 'standard_railway_text_stations_med',
      paint: {
        'text-color': colors.styles.standard.stationsText,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 2,
        'icon-color': colors.styles.standard.stationsText,
        'icon-halo-width': 2,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'symbol-z-order': 'source',
        'icon-image': ['image', ['concat', 'sdf:general/station-', ['get', 'station_size']]],
        'icon-overlap': 'always',
        'text-field': ['match', ['get', 'station_size'],
          'small', '',
          ['match', ['global-state', 'stationLowZoomLabel'],
            'label', ['get', 'label'],
            'name', ['get', 'localized_name'],
            '',
          ],
        ],
        'text-font': font.bold,
        'text-size': 11,
        'text-padding': 10,
        'text-max-width': 8,
        'text-optional': true,
        'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
      },
    },
    {
      id: 'railway_turntables_fill',
      type: 'fill',
      minzoom: 10,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_turntables',
      paint: {
        'fill-color': colors.styles.standard.turntable.fill,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
      },
    },
    {
      id: 'railway_turntables_casing',
      type: 'line',
      minzoom: 15,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_turntables',
      paint: {
        'line-color': colors.styles.standard.turntable.casing,
        'line-width': turntable_casing_width,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
      },
    },
    {
      id: 'railway_stop_positions',
      type: 'circle',
      minzoom: 16,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_stop_positions',
      paint: {
        'circle-radius': ['interpolate', ['linear'], ['zoom'],
          16, 2,
          19, 5,
        ],
        'circle-color': ['match', ['get', 'type'],
          'train', colors.styles.standard.main,
          'tram', colors.styles.standard.tram,
          'light_rail', colors.styles.standard.light_rail,
          'subway', colors.styles.standard.subway,
          'funicular', colors.styles.standard.funicular,
          'monorail', colors.styles.standard.monorail,
          'miniature', colors.styles.standard.miniature,
          colors.styles.standard.unknown,
        ],
        'circle-stroke-width': 2,
        'circle-stroke-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          colors.halo,
        ],
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
      },
    },
    {
      id: `railway_symbols_colored`,
      type: 'symbol',
      minzoom: 12,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_symbols',
      paint: {
        'icon-color': colors.styles.standard.symbols,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'icon-halo-blur': ['case',
          ['boolean', ['feature-state', 'hover'], false], 1.0,
          0.0,
        ],
        'icon-halo-width': ['case',
          ['boolean', ['feature-state', 'hover'], false], 3.0,
          2.0,
        ],
        'text-color': colors.styles.standard.symbols,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 2,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'symbol-z-order': 'source',
        'icon-overlap': 'always',
        'icon-image': ['concat', 'sdf:', ['get', 'feature']],
        'text-field': ['coalesce', ['get', 'ref'], ''],
        'text-font': font.regular,
        'text-size': 11,
        'text-padding': 15,
        'text-offset': [0, 1.5],
        'text-optional': true,
      },
    },
    ...imageLayerWithOutline(
      `railway_symbols_outline`,
      ['get', 'feature'],
      {
        type: 'symbol',
        minzoom: 12,
        source: 'openrailwaymap_standard',
        'source-layer': 'standard_railway_symbols',
        layout: {
          'symbol-z-order': 'source',
          'icon-overlap': 'always',
        },
      },
    ),
    {
      id: 'railway_platforms_polygon_text',
      type: 'symbol',
      minzoom: 17,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_platforms',
      filter: ['all',
        ['any',
          ['==', ["geometry-type"], 'Polygon'],
          ['==', ["geometry-type"], 'MultiPolygon'],
        ],
        ['!=', ["get", "name"], null],
      ],
      paint: {
        'text-color': colors.styles.standard.defaultText,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'text-field': '{name}',
        'text-font': font.regular,
        'text-size': 11,
        'text-padding': 10,
      },
    },
    {
      id: 'railway_platforms_line_text',
      type: 'symbol',
      minzoom: 17,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_platforms',
      filter: ['==', ["geometry-type"], 'LineString'],
      paint: {
        'text-color': colors.styles.standard.defaultText,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'text-field': '{name}',
        'text-font': font.regular,
        'text-size': 11,
        'text-padding': 10,
        'symbol-placement': 'line',
      },
    },
    {
      id: 'standard_railway_platform_edges_text',
      type: 'symbol',
      minzoom: 17,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_platform_edges',
      filter: ['!=', ['get', 'ref'], null],
      paint: {
        'text-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.styles.standard.track.hover,
          colors.styles.standard.track.text,
        ],
        'text-halo-color': colors.styles.standard.track.halo,
        'text-halo-width': 4,
        'text-halo-blur': 2,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'symbol-placement': 'line',
        'text-field': '{ref}',
        'text-font': font.bold,
        'text-size': 10,
        'text-padding': 10,
      },
    },
    {
      id: 'standard_station_entrances',
      type: 'symbol',
      minzoom: 16,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_station_entrances',
      paint: {
        'icon-color': colors.styles.standard.subway,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'icon-halo-blur': ['case',
          ['boolean', ['feature-state', 'hover'], false], 1.0,
          0.0,
        ],
        'icon-halo-width': ['case',
          ['boolean', ['feature-state', 'hover'], false], 3.0,
          2.0,
        ],
        'text-color': colors.styles.standard.subway,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 2,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'symbol-z-order': 'source',
        'icon-overlap': 'always',
        'icon-image': 'sdf:general/subway-entrance',
        'text-field': '{label}',
        'text-font': font.regular,
        'text-size': 11,
        'text-padding': 15,
        'text-offset': [0, 1.5],
        'text-optional': true,
      },
    },
    {
      id: 'railway_text_track_numbers',
      type: 'symbol',
      minzoom: 16,
      source: 'high',
      'source-layer': 'railway_line_high',
      filter: ['all',
        ['!=', ['get', 'track_ref'], null],
        ['match', ['get', 'state'],
          'construction', ['global-state', 'showConstructionInfrastructure'],
          'proposed', ['global-state', 'showProposedInfrastructure'],
          'abandoned', ['global-state', 'showAbandonedInfrastructure'],
          'razed', ['global-state', 'showRazedInfrastructure'],
          true,
        ],
      ],
      paint: {
        'text-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.styles.standard.track.hover,
          colors.styles.standard.track.text,
        ],
        'text-halo-color': colors.styles.standard.track.halo,
        'text-halo-width': 4,
        'text-halo-blur': 2,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'symbol-z-order': 'source',
        'symbol-placement': 'line',
        'text-field': '{track_ref}',
        'text-font': font.bold,
        'text-size': 10,
        'text-padding': 10,
      },
    },
    {
      id: `railway_switch`,
      type: 'symbol',
      minzoom: 17,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_switch_ref',
      paint: {
        'icon-color': ['case',
          ['get', 'local_operated'], colors.styles.standard.switch.localOperated,
          ['get', 'resetting'], colors.styles.standard.switch.resetting,
          colors.styles.standard.switch.default,
        ],
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'icon-halo-blur': ['case',
          ['boolean', ['feature-state', 'hover'], false], 1.0,
          0.0,
        ],
        'icon-halo-width': ['case',
          ['boolean', ['feature-state', 'hover'], false], 3.0,
          2.0,
        ],
        'text-color': ['case',
          ['get', 'local_operated'], colors.styles.standard.switch.localOperated,
          ['get', 'local_operated'], colors.styles.standard.switch.resetting,
          colors.styles.standard.switch.default,
        ],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 2,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'icon-overlap': 'always',
        'icon-image': ['image',
          ['match', ['get', 'railway'],
            'switch', ['match', ['get', 'type'],
              'double_slip', 'sdf:general/switch-double-slip',
              'single_slip', 'sdf:general/switch-single-slip',
              'wye', 'sdf:general/switch-wye',
              'three_way', 'sdf:general/switch-three-way',
              'four_way', 'sdf:general/switch-four-way',
              'abt', 'sdf:general/switch-abt',
              ['match', ['get', 'turnout_side'],
                'left', 'sdf:general/switch-default-left',
                'right', 'sdf:general/switch-default-right',
                'sdf:general/switch-default',
              ],
            ],
            'railway_crossing', 'sdf:general/railway-crossing',
            'sdf:general/switch-default',
          ],
        ],
        'symbol-z-order': 'source',
        'text-field': ['coalesce', ['get', 'ref'], ''],
        'text-font': font.regular,
        'text-size': 11,
        'text-padding': 15,
        'text-offset': [0, 1.5],
        'text-optional': true,
      },
    },
    {
      id: 'railway_text_stations',
      type: 'symbol',
      minzoom: 8,
      maxzoom: 13,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_text_stations',
      filter: ['step', ['zoom'],
        ['all',
          ['==', ['get', 'state'], 'present'],
          ['any',
            ['==', ['get', 'feature'], 'station'],
            ['==', ['get', 'feature'], 'yard'],
          ],
          ['!=', ['get', 'station'], 'light_rail'],
          ['!=', ['get', 'station'], 'subway'],
          ['!=', ['get', 'station'], 'monorail'],
          ['!=', ['get', 'station'], 'funicular'],
        ],
        9,
        ['all',
          ['==', ['get', 'state'], 'present'],
          ['any',
            ['==', ['get', 'feature'], 'station'],
            ['==', ['get', 'feature'], 'yard'],
            ['==', ['get', 'feature'], 'halt'],
          ],
          ['!=', ['get', 'station'], 'light_rail'],
          ['!=', ['get', 'station'], 'tram'],
          ['!=', ['get', 'station'], 'subway'],
          ['!=', ['get', 'station'], 'monorail'],
          ['!=', ['get', 'station'], 'funicular'],
        ],
        10,
        ['all',
          ['match', ['get', 'state'],
            'construction', ['global-state', 'showConstructionInfrastructure'],
            'proposed', ['global-state', 'showProposedInfrastructure'],
            'disused', false,
            'abandoned', false,
            true,
          ],
          ['!=', ['get', 'station'], 'tram'],
          ['!=', ['get', 'station'], 'funicular'],
          ['!=', ['get', 'station'], 'miniature'],
        ],
        11,
        ['all',
          ['match', ['get', 'state'],
            'construction', ['global-state', 'showConstructionInfrastructure'],
            'proposed', ['global-state', 'showProposedInfrastructure'],
            'abandoned', false,
            true,
          ],
          ['!=', ['get', 'station'], 'funicular'],
          ['!=', ['get', 'station'], 'miniature'],
        ],
        12,
        ['match', ['get', 'state'],
          'construction', ['global-state', 'showConstructionInfrastructure'],
          'proposed', ['global-state', 'showProposedInfrastructure'],
          'abandoned', ['global-state', 'showAbandonedInfrastructure'],
          'razed', ['global-state', 'showRazedInfrastructure'],
          true,
        ],
      ],
      paint: {
        'text-color': ['case',
          ['==', ['get', 'feature'], 'yard'], colors.styles.standard.yardText,
          ['any',
            ['==', ['get', 'feature'], 'station'],
            ['==', ['get', 'feature'], 'halt'],
            ['==', ['get', 'feature'], 'tram_stop'],
          ], ['case',
            ['==', ['get', 'station'], 'light_rail'], colors.styles.standard.lightRailText,
            ['==', ['get', 'station'], 'monorail'], colors.styles.standard.monorailText,
            ['==', ['get', 'station'], 'tram'], colors.styles.standard.tramStopText,
            ['==', ['get', 'station'], 'miniature'], colors.styles.standard.miniatureText,
            ['==', ['get', 'station'], 'funicular'], colors.styles.standard.funicularText,
            colors.styles.standard.stationsText,
          ],
          colors.styles.standard.defaultText,
        ],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
        'icon-color': ['case',
          ['==', ['get', 'feature'], 'yard'], colors.styles.standard.yardText,
          ['any',
            ['==', ['get', 'feature'], 'station'],
            ['==', ['get', 'feature'], 'halt'],
            ['==', ['get', 'feature'], 'tram_stop'],
          ], ['case',
            ['==', ['get', 'station'], 'light_rail'], colors.styles.standard.lightRailText,
            ['==', ['get', 'station'], 'monorail'], colors.styles.standard.monorailText,
            ['==', ['get', 'station'], 'tram'], colors.styles.standard.tramStopText,
            ['==', ['get', 'station'], 'miniature'], colors.styles.standard.miniatureText,
            ['==', ['get', 'station'], 'funicular'], colors.styles.standard.funicularText,
            colors.styles.standard.stationsText,
          ],
          colors.styles.standard.defaultText,
        ],
        'icon-halo-width': 1.5,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'symbol-z-order': 'source',
        'icon-image': ['image', ['concat', 'sdf:general/station-', ['case',
          ['in', ['get', 'state'], ['literal', ['disused', 'abandoned', 'preserved', 'razed']]], 'past',
          ['in', ['get', 'state'], ['literal', ['construction', 'proposed']]], 'future',
          ['get', 'station_size'],
        ]]],
        'icon-overlap': 'always',
        'text-field': ['step', ['zoom'],
          ['match', ['global-state', 'stationLowZoomLabel'],
            'label', ['get', 'label'],
            'name', ['get', 'localized_name'],
            '',
          ],
          10,
          ['get', 'localized_name'],
          12,
          ['format',
            ['get', 'localized_name'],
            {},
            ['case',
              ['!=', ['get', 'name'], ['get', 'localized_name']], ['concat', '\n', ['get', 'name']],
              '',
            ],
            {
              'text-font': ['literal', font.regular],
            },
          ],
        ],
        'text-font': ['case',
          ['in', ['get', 'state'], ['literal', ['construction', 'proposed']]], ['literal', font.italic],
          ['literal', font.bold],
        ],
        'text-size': 11,
        'text-padding': 10,
        'text-max-width': 8,
        'text-optional': true,
        'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
      },
    },
    {
      id: 'railway_text_stations_high',
      type: 'symbol',
      minzoom: 13,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_text_stations',
      filter: ['match', ['get', 'state'],
        'construction', ['global-state', 'showConstructionInfrastructure'],
        'proposed', ['global-state', 'showProposedInfrastructure'],
        'abandoned', ['global-state', 'showAbandonedInfrastructure'],
        'razed', ['global-state', 'showRazedInfrastructure'],
        true,
      ],
      paint: {
        'text-color': ['case',
          ['==', ['get', 'feature'], 'yard'], colors.styles.standard.yardText,
          ['any',
            ['==', ['get', 'feature'], 'station'],
            ['==', ['get', 'feature'], 'halt'],
            ['==', ['get', 'feature'], 'tram_stop'],
          ], ['case',
            ['==', ['get', 'station'], 'light_rail'], colors.styles.standard.lightRailText,
            ['==', ['get', 'station'], 'monorail'], colors.styles.standard.monorailText,
            ['==', ['get', 'station'], 'miniature'], colors.styles.standard.miniatureText,
            ['==', ['get', 'station'], 'funicular'], colors.styles.standard.funicularText,
            ['==', ['get', 'station'], 'tram'], colors.styles.standard.tramStopText,
            colors.styles.standard.stationsText,
          ],
          colors.styles.standard.defaultText,
        ],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
      },
      layout: {
        'visibility': ['case',
          ['<', ['global-state', 'date'], defaultDate], 'none',
          'visible',
        ],
        'symbol-z-order': 'source',
        'text-field': ['step', ['zoom'],
          ['format',
            ['get', 'localized_name'],
            {},
            ['case',
              ['!=', ['get', 'name'], ['get', 'localized_name']], ['concat', '\n', ['get', 'name']],
              '',
            ],
            {
              'text-font': ['literal', font.regular],
            },
          ],
          15,
          ['format',
            ['get', 'localized_name'],
            {},
            ['case',
              ['>', ['coalesce', ['get', 'count'], 0], 1], ['concat', ' (', ['get', 'count'], ')'],
              '',
            ],
            {},
            ['case',
              ['!=', ['get', 'name'], ['get', 'localized_name']], ['concat', '\n', ['get', 'name']],
              '',
            ],
            {
              'text-font': ['literal', font.regular],
            },
          ],
        ],
        'text-font': ['case',
          ['in', ['get', 'state'], ['literal', ['construction', 'proposed']]], ['literal', font.italic],
          ['literal', font.bold],
        ],
        'text-variable-anchor': ['center', 'top', 'bottom', 'left', 'right'],
        'text-size': 11,
        'text-padding': 10,
        'text-max-width': 8,
      },
    },
    {
      id: 'historical_stations',
      type: 'symbol',
      minzoom: 12,
      source: 'openhistoricalmap',
      'source-layer': 'transport_points_centroids',
      filter: ['all',
        ['any',
          ['global-state', 'allDates'],
          ['all',
            ['<=', ['coalesce', ['get', 'start_decdate'], 0.0], ['global-state', 'date']],
            ['<=', ['global-state', 'date'], ['coalesce', ['get', 'end_decdate'], 9999.0]],
          ],
        ],
        ['==', ['get', 'class'], 'railway'],
        ['in', ['get', 'type'], ['literal', ['station', 'halt']]],
      ],
      paint: {
        'text-color': ['case',
          ['==', ['get', 'type'], 'halt'], colors.styles.standard.tramStopText,
          colors.styles.standard.stationsText,
        ],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
        'icon-color': ['case',
          ['==', ['get', 'type'], 'halt'], colors.styles.standard.tramStopText,
          colors.styles.standard.stationsText,
        ],
        'icon-halo-width': 1,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'visibility': ['case',
          ['all',
            ['global-state', 'openHistoricalMap'],
            ['any',
              ['global-state', 'allDates'],
              ['<', ['global-state', 'date'], defaultDate],
            ],
          ], 'visible',
          'none',
        ],
        'symbol-z-order': 'source',
        'icon-image': ['case',
          ['global-state', 'allDates'], 'sdf:general/station-past',
          'sdf:general/station-small',
        ],
        'icon-overlap': 'always',
        'text-field': '{name}',
        'text-font': font.bold,
        'text-size': 11,
        'text-padding': 10,
        'text-max-width': 5,
        'text-optional': true,
        'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
      },
    },
    searchResults,
  ],

  speed: [
    hillshade,
    ...railwayLine(
      ['coalesce', ['get', 'speed_label'], ''],
      [
        {
          id: 'speed_low',
          minzoom: 0,
          maxzoom: 7,
          source: 'speed_railway_line_low',
          sourceLayer: 'speed_railway_line_low',
          states: {
            present: undefined,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: speedColor,
          hoverColor: speedHoverColor,
        },
        {
          id: 'speed_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: 2,
          color: speedColor,
          hoverColor: speedHoverColor,
        },
        {
          id: 'speed_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
            disused: disused_dasharray,
            preserved: disused_dasharray,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: speedColor,
          hoverColor: speedHoverColor,
        },
      ],
    ),
    {
      id: 'speed_railway_signal_direction',
      type: 'symbol',
      minzoom: 13,
      source: 'openrailwaymap_speed',
      'source-layer': 'speed_railway_signals',
      filter: ['step', ['zoom'],
        ['all',
          ['!=', ['get', 'feature0'], null],
          ['!=', ['get', 'azimuth'], null],
          ['==', ['get', 'type'], 'line'],
        ],
        14,
        ['all',
          ['!=', ['get', 'feature0'], null],
          ['!=', ['get', 'azimuth'], null],
          ['any',
            ['==', ['get', 'type'], 'line'],
            ['==', ['get', 'type'], 'tram'],
          ]
        ],
        16,
        ['all',
          ['!=', ['get', 'feature0'], null],
          ['!=', ['get', 'azimuth'], null],
        ],
      ],
      paint: {
        'icon-color': colors.signals.direction,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'icon-halo-width': 2.0,
        'icon-halo-blur': 1.0,
        'icon-opacity': ['interpolate', ['linear'], ['zoom'],
          15, 0.85,
          16, 0.7,
        ],
      },
      layout: {
        'icon-overlap': 'always',
        'icon-image': ["step", ["zoom"],
          ['case',
            ['coalesce', ['get', 'direction_both'], false], 'sdf:general/signal-direction-both',
            'sdf:general/signal-direction',
          ],
          16, ['case',
            ['coalesce', ['get', 'direction_both'], false], 'sdf:general/signal-direction-large-both',
            'sdf:general/signal-direction-large',
          ],
        ],
        'icon-anchor': ['case',
          ['coalesce', ['get', 'direction_both'], false], 'center',
          'top',
        ],
        'icon-rotate': ['get', 'azimuth'],
        'icon-keep-upright': true,
        'icon-rotation-alignment': 'map',
      },
    },
    ...[0, 1].flatMap(featureIndex => [
      ...imageLayerWithOutline(
        `speed_railway_signals_${featureIndex}`,
        ['get', `feature${featureIndex}`],
        {
          type: 'symbol',
          minzoom: 13,
          source: 'openrailwaymap_speed',
          'source-layer': 'speed_railway_signals',
          filter: ['step', ['zoom'],
            ['all',
              ['!=', ['get', `feature${featureIndex}`], null],
              ['==', ['get', 'type'], 'line'],
            ],
            14,
            ['all',
              ['!=', ['get', `feature${featureIndex}`], null],
              ['any',
                ['==', ['get', 'type'], 'line'],
                ['==', ['get', 'type'], 'tram'],
              ]
            ],
            16,
            ['!=', ['get', `feature${featureIndex}`], null],
          ],
          layout: {
            'symbol-z-order': 'source',
            'icon-overlap': 'always',
            'icon-offset': featureIndex === 0
              ? ['literal', [0, 0]]
              : ['interpolate', ['linear'],
                // Gap of 2 pixels for halo and spacing
                ['+', ['get', `offset${featureIndex}`], 2 * featureIndex],
                0, ['literal', [0, 0]],
                1000, ['literal', [0, -1000]],
              ],
          },
        },
      ),
      {
        id: `speed_railway_signals_deactivated_${featureIndex}`,
        type: 'symbol',
        minzoom: 13,
        source: 'openrailwaymap_speed',
        'source-layer': 'speed_railway_signals',
        filter: ['==', ['get', `deactivated${featureIndex}`], true],
        layout: {
          'symbol-z-order': 'source',
          'icon-overlap': 'always',
          'icon-image': 'general/signal-deactivated',
          'icon-offset': featureIndex === 0
            ? ['literal', [0, 0]]
            : ['interpolate', ['linear'],
              // Gap of 2 pixels for halo and spacing
              ['+', ['get', `offset${featureIndex}`], 2 * featureIndex],
              0, ['literal', [0, 0]],
              1000, ['literal', [0, -1000]],
            ],
        }
      },
    ]),
    {
      id: `speed_railway_signals_text`,
      type: 'symbol',
      minzoom: 16,
      source: 'openrailwaymap_speed',
      'source-layer': 'speed_railway_signals',
      filter: ['any',
        ['!=', ['get', 'ref'], null],
        ['!=', ['get', 'caption'], null],
      ],
      paint: {
        'text-color': colors.text.main,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo
        ],
        'text-halo-width': 1.5,
        'text-halo-blur': 1,
      },
      layout: {
        'text-field': ['format',
          ['get', 'ref'], {},
          ['case', ['all', ['!=', ['get', 'ref'], null], ['!=', ['get', 'caption'], null]], '\n', ''], {},
          ['case', ['==', ['get', 'caption'], null], '', ['get', 'caption']], {'text-font': ['literal', font.italic]},
        ],
        'text-font': font.regular,
        'text-size': 9,
        'text-anchor': 'top',
        'text-offset': [0, 1.5],
      },
    },
    searchResults,
  ],

  signals: [
    hillshade,
    ...railwayLine(
      '',
      [
        {
          id: 'railway_line_low',
          minzoom: 0,
          maxzoom: 7,
          source: 'signals_railway_line_low',
          sourceLayer: 'signals_railway_line_low',
          states: {
            present: undefined,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          sort: ['get', 'train_protection_rank'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: trainProtectionColor('train_protection'),
        },
        {
          id: 'railway_line_low_construction',
          minzoom: 0,
          maxzoom: 7,
          source: 'signals_railway_line_low',
          sourceLayer: 'signals_railway_line_low',
          states: {
            present: train_protection_construction_dasharray,
          },
          filter: ['all',
            ['!=', ['get', 'feature'], 'ferry'],
            ['!=', null, ['get', 'train_protection_construction']],
          ],
          sort: ['get', 'train_protection_construction_rank'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: trainProtectionColor('train_protection_construction'),
        },
        {
          id: 'railway_line_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          sort: ['get', 'train_protection_rank'],
          width: 2,
          color: trainProtectionColor('train_protection'),
        },
        {
          id: 'railway_line_med_construction',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: train_protection_construction_dasharray,
            construction: train_protection_construction_dasharray,
            proposed: train_protection_construction_dasharray,
          },
          filter: ['all',
            ['!=', ['get', 'feature'], 'ferry'],
            ['!=', null, ['get', 'train_protection_construction']],
          ],
          sort: ['get', 'train_protection_construction_rank'],
          width: 2,
          color: trainProtectionColor('train_protection_construction'),
        },
        {
          id: 'railway_line_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
            disused: disused_dasharray,
            preserved: disused_dasharray,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          sort: ['get', 'train_protection_rank'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: trainProtectionColor('train_protection'),
        },
        {
          id: 'railway_line_high_construction',
          minzoom: 8,
          source: 'high',
          states: {
            present: train_protection_construction_dasharray,
            construction: train_protection_construction_dasharray,
            proposed: train_protection_construction_dasharray,
            disused: train_protection_construction_dasharray,
            preserved: train_protection_construction_dasharray,
          },
          filter: ['all',
            ['!=', ['get', 'feature'], 'ferry'],
            ['!=', null, ['get', 'train_protection_construction']],
          ],
          sort: ['get', 'train_protection_construction_rank'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: trainProtectionColor('train_protection_construction'),
        },
      ],
    ),
    {
      id: 'signal_boxes_point',
      type: 'circle',
      minzoom: 10,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['==', ["geometry-type"], 'Point'],
      paint: {
        'circle-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          '#008206',
        ],
        'circle-radius': 4,
        'circle-stroke-color': 'white',
        'circle-stroke-width': 1,
      },
    },
    {
      id: 'signal_boxes_polygon',
      type: 'fill',
      minzoom: 14,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['any',
        ['==', ["geometry-type"], 'Polygon'],
        ['==', ["geometry-type"], 'MultiPolygon'],
      ],
      paint: {
        'fill-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          '#008206',
        ],
        'fill-outline-color': 'white',
      },
    },
    {
      id: 'signal_boxes_polygon_outline',
      type: 'line',
      minzoom: 14,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['any',
        ['==', ["geometry-type"], 'Polygon'],
        ['==', ["geometry-type"], 'MultiPolygon'],
      ],
      paint: {
        'line-color': 'white',
        'line-width': 1,
      },
    },
    {
      id: 'railway_signals_direction',
      type: 'symbol',
      minzoom: 13,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_railway_signals',
      filter: ['step', ['zoom'],
        ['all',
          ['==', ['get', 'railway'], 'signal'],
          ['!=', ['get', 'azimuth'], null],
          ['!=', ['get', 'feature0'], ''],
        ],
        13,
        ['all',
          ['!=', ['get', 'azimuth'], null],
          ['!=', ['get', 'feature0'], ''],
        ],
      ],
      paint: {
        'icon-color': colors.signals.direction,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'icon-halo-width': 2.0,
        'icon-halo-blur': 1.0,
        'icon-opacity': ['interpolate', ['linear'], ['zoom'],
          15, 0.85,
          16, 0.7,
        ],
      },
      layout: {
        'icon-overlap': 'always',
        'icon-image': ["step", ["zoom"],
          ['case',
            ['coalesce', ['get', 'direction_both'], false], 'sdf:general/signal-direction-both',
            'sdf:general/signal-direction',
          ],
          16, ['case',
            ['coalesce', ['get', 'direction_both'], false], 'sdf:general/signal-direction-large-both',
            'sdf:general/signal-direction-large',
          ],
        ],
        'icon-anchor': ['case',
          ['coalesce', ['get', 'direction_both'], false], 'center',
          'top',
        ],
        'icon-rotate': ['get', 'azimuth'],
        'icon-keep-upright': true,
        'icon-rotation-alignment': 'map',
      },
    },
    // Show at most 2 combined features
    ...[0, 1].flatMap(featureIndex => [
      ...imageLayerWithOutline(
        `railway_signals_medium_${featureIndex}`,
        ['get', `feature${featureIndex}`],
        {
          type: 'symbol',
          minzoom: 13,
          maxzoom: 16,
          source: 'openrailwaymap_signals',
          'source-layer': 'signals_railway_signals',
          filter: ['all',
            ['==', ['get', 'railway'], 'signal'],
            ['!=', ['get', `feature${featureIndex}`], null],
          ],
          layout: {
            'symbol-z-order': 'source',
            'icon-overlap': 'always',
            'icon-offset': featureIndex === 0
              ? ['literal', [0, 0]]
              : ['interpolate', ['linear'],
                // Gap of 2 pixels for halo and spacing
                ['+', ['get', `offset${featureIndex}`], 2 * featureIndex],
                0, ['literal', [0, 0]],
                1000, ['literal', [0, -1000]],
              ],
          },
        },
      ),
      {
        id: `railway_signals_medium_deactivated_${featureIndex}`,
        type: 'symbol',
        minzoom: 13,
        maxzoom: 16,
        source: 'openrailwaymap_signals',
        'source-layer': 'signals_railway_signals',
        filter: ['==', ['get', `deactivated${featureIndex}`], true],
        layout: {
          'symbol-z-order': 'source',
          'icon-overlap': 'always',
          'icon-image': 'general/signal-deactivated',
          'icon-offset': featureIndex === 0
            ? ['literal', [0, 0]]
            : ['interpolate', ['linear'],
              // Gap of 2 pixels for halo and spacing
              ['+', ['get', `offset${featureIndex}`], 2 * featureIndex],
              0, ['literal', [0, 0]],
              1000, ['literal', [0, -1000]],
            ],
        }
      },
    ]),
    {
      id: 'railway_signals_high_derail_buffer_stop',
      type: 'symbol',
      minzoom: 16,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_railway_signals',
      filter: ['in', ['get', 'railway'], ['literal', ['derail', 'buffer_stop']]],
      paint: {
        'icon-color': colors.styles.signals.bufferStopDerailer,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'icon-halo-width': 1,
      },
      layout: {
        'symbol-z-order': 'source',
        'icon-overlap': 'always',
        'icon-image': ['case',
          ['==', ['get', 'railway'], 'derail'], 'sdf:general/derail',
          ['==', ['get', 'railway'], 'buffer_stop'], 'sdf:general/buffer_stop-signal',
          ''
        ],
        'icon-rotate': ['get', 'azimuth'],
        'icon-keep-upright': true,
        'icon-rotation-alignment': 'map',
      },
    },
    ...[0, 1, 2, 3, 4, 5].flatMap(featureIndex => [
      ...imageLayerWithOutline(
        `railway_signals_high_${featureIndex}`,
        ['get', `feature${featureIndex}`],
        {
          type: 'symbol',
          minzoom: 16,
          source: 'openrailwaymap_signals',
          'source-layer': 'signals_railway_signals',
          filter: ['!=', ['get', `feature${featureIndex}`], null],
          layout: {
            'symbol-z-order': 'source',
            'icon-overlap': 'always',
            'icon-anchor': 'center',
            'icon-offset': ['interpolate', ['linear'],
              // Gap of 2 pixels for halo and spacing
              ['+',
                featureIndex === 0 ? 0 : ['get', `offset${featureIndex}`],
                ['case',
                  ['in', ['get', 'railway'], ['literal', ['derail', 'buffer_stop']]], 16,
                  0
                ],
                2 * featureIndex
              ],
              0, ['literal', [0, 0]],
              1000, ['literal', [0, -1000]],
            ],
          },
        },
      ),
      {
        id: `railway_signals_high_deactivated_${featureIndex}`,
        type: 'symbol',
        minzoom: 16,
        source: 'openrailwaymap_signals',
        'source-layer': 'signals_railway_signals',
        filter: ['==', ['get', `deactivated${featureIndex}`], true],
        layout: {
          'symbol-z-order': 'source',
          'icon-overlap': 'always',
          'icon-image': 'general/signal-deactivated',
          'icon-offset': featureIndex === 0
            ? ['literal', [0, 0]]
            : ['interpolate', ['linear'],
              // Gap of 2 pixels for halo and spacing
              ['+', ['get', `offset${featureIndex}`], 2 * featureIndex],
              0, ['literal', [0, 0]],
              1000, ['literal', [0, -1000]],
            ],
        }
      },
    ]),
    {
      id: `railway_signals_high_text`,
      type: 'symbol',
      minzoom: 16,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_railway_signals',
      filter: ['all',
        ['any',
          ['!=', ['get', 'ref'], null],
          ['!=', ['get', 'caption'], null],
        ],
        ['!=', ['get', 'feature0'], null],
      ],
      paint: {
        'text-color': colors.text.main,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo
        ],
        'text-halo-width': 1.5,
        'text-halo-blur': 1,
      },
      layout: {
        'symbol-z-order': 'source',
        'text-field': ['format',
          ['get', 'ref'], {},
          ['case', ['all', ['!=', ['get', 'ref'], null], ['!=', ['get', 'caption'], null]], '\n', ''], {},
          ['case', ['==', ['get', 'caption'], null], '', ['get', 'caption']], {'text-font': ['literal', font.italic]},
        ],
        'text-font': font.regular,
        'text-size': 9,
        'text-anchor': 'top',
        'text-offset': [0, 1.5],
      },
    },
    {
      id: 'signal_boxes_text_medium',
      type: 'symbol',
      minzoom: 12,
      maxzoom: 15,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['!=', ['get', 'ref'], null],
      paint: {
        'text-color': colors.styles.standard.signalBox.text,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.styles.standard.signalBox.halo,
        ],
        'text-halo-width': 1.5,
      },
      layout: {
        'text-field': '{ref}',
        'text-font': font.bold,
        'text-size': 11,
        'text-offset': ['literal', [0, 1]],
      }
    },
    {
      id: 'signal_boxes_text_high',
      type: 'symbol',
      minzoom: 15,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['any',
        ['!=', ['get', 'name'], null],
        ['!=', ['get', 'ref'], null],
      ],
      paint: {
        'text-color': colors.styles.standard.signalBox.text,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.styles.standard.signalBox.halo,
        ],
        'text-halo-width': 1.5,
      },
      layout: {
        'text-field': ['coalesce', ['get', 'name'], ['get', 'ref'], ''],
        'text-font': font.bold,
        'text-size': 11,
      }
    },
    searchResults,
  ],

  electrification: [
    hillshade,
    ...railwayLine(
      ['match', ['global-state', 'electrificationRailwayLine'],
        'maximumCurrent', ['get', 'maximum_current'],
        ['get', 'electrification_label'],
      ],
      [
        {
          id: 'railway_line_low',
          minzoom: 0,
          maxzoom: 7,
          source: 'electrification_railway_line_low',
          sourceLayer: 'electrification_railway_line_low',
          states: {
            present: undefined,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: ['match', ['global-state', 'electrificationRailwayLine'],
            'maximumCurrent', electrificationVoltageMaximumCurrentColor('maximum_current'),
            electrificationVoltageFrequencyColor('voltage', 'frequency'),
          ],
        },
        {
          id: 'railway_line_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: 2,
          color: ['match', ['global-state', 'electrificationRailwayLine'],
            'maximumCurrent', electrificationVoltageMaximumCurrentColor('maximum_current'),
            electrificationVoltageFrequencyColor('voltage', 'frequency'),
          ],
        },
        {
          id: 'railway_line_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: undefined,
            proposed: undefined,
            disused: undefined,
            preserved: undefined,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, ['match', ['get', 'state'],
              'present', 2,
              1.5,
            ],
            16, ['match', ['get', 'state'],
              'present', 3,
              2,
            ],
          ],
          color: ['match', ['global-state', 'electrificationRailwayLine'],
            'maximumCurrent', electrificationVoltageMaximumCurrentColor('maximum_current'),
            electrificationVoltageFrequencyColor('voltage', 'frequency'),
          ],
        },
        {
          id: 'railway_line_high_proposed',
          minzoom: 8,
          source: 'high',
          states: {
            present: electrification_proposed_dashes,
            construction: electrification_proposed_dashes,
            proposed: electrification_proposed_dashes,
            disused: electrification_proposed_dashes,
            preserved: electrification_proposed_dashes,
          },
          filter: ['all',
            ['!=', ['get', 'feature'], 'ferry'],
            ['==', ['get', 'electrification_state'], 'proposed'],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, ['match', ['get', 'state'],
              'present', 2,
              1.5,
            ],
            16, ['match', ['get', 'state'],
              'present', 3,
              2,
            ],
          ],
          color: ['match', ['global-state', 'electrificationRailwayLine'],
            'maximumCurrent', electrificationVoltageMaximumCurrentColor('future_maximum_current'),
            electrificationVoltageFrequencyColor('future_voltage', 'future_frequency'),
          ],
        },
        {
          id: 'railway_line_high_construction',
          minzoom: 8,
          source: 'high',
          states: {
            present: electrification_construction_dashes,
            construction: electrification_construction_dashes,
            proposed: electrification_construction_dashes,
            disused: electrification_construction_dashes,
            preserved: electrification_construction_dashes,
          },
          filter: ['all',
            ['!=', ['get', 'feature'], 'ferry'],
            ['==', ['get', 'electrification_state'], 'construction'],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: ['match', ['global-state', 'electrificationRailwayLine'],
            'maximumCurrent', electrificationVoltageMaximumCurrentColor('future_maximum_current'),
            electrificationVoltageFrequencyColor('future_voltage', 'future_frequency'),
          ],
        },
      ],
    ),
    {
      id: 'electrification_substation',
      type: 'fill',
      minzoom: 13,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_substation',
      paint: {
        'fill-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          colors.substation,
        ],
      },
    },
    {
      id: `electrification_substation_outline`,
      type: 'line',
      minzoom: 13,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_substation',
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'line-width': 2,
      },
    },
    {
      id: 'electrification_catenary_mast',
      type: 'symbol',
      minzoom: 14,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_catenary',
      filter: ['==', ['get', 'feature'], 'mast'],
      paint: {
        'icon-color': colors.catenary,
        'icon-halo-width': 2,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'icon-image': ['case',
          ['get', 'transition'], 'sdf:general/catenary-mast-transition',
          'sdf:general/catenary-mast',
        ],
        'icon-overlap': 'always',
        'icon-size': ['interpolate', ['exponential', 1.2], ['zoom'],
          14, 0.5,
          15, 0.75,
          17, 1.0,
        ],
      },
    },
    {
      id: 'electrification_catenary_mast_text',
      type: 'symbol',
      minzoom: 17,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_catenary',
      filter: ['all',
        ['==', ['get', 'feature'], 'mast'],
        ['!=', ['get', 'ref'], null],
      ],
      paint: {
        'text-color': colors.catenary,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 2,
      },
      layout: {
        'text-field': '{ref}',
        'text-font': font.bold,
        'text-size': 11,
        'text-padding': 6,
        'text-max-width': 5,
        'text-offset': [0, 1],
      },
    },
    {
      id: 'electrification_catenary_portal',
      type: 'line',
      minzoom: 14,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_catenary',
      filter: ['==', ['get', 'feature'], 'portal'],
      paint: {
        'line-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.catenary,
        ],
        'line-width': ['interpolate', ['exponential', 1.2], ['zoom'],
          14, 1.5,
          15, 2.0,
        ],
      },
    },
    {
      id: 'electrification_signals_direction',
      type: 'symbol',
      minzoom: 13,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_signals',
      filter: ['all',
        ['!=', ['get', 'azimuth'], null],
        ['!=', ['get', 'feature'], ''],
      ],
      paint: {
        'icon-color': colors.signals.direction,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'icon-halo-width': 2.0,
        'icon-halo-blur': 1.0,
        'icon-opacity': ['interpolate', ['linear'], ['zoom'],
          15, 0.85,
          16, 0.7,
        ],
      },
      layout: {
        'icon-overlap': 'always',
        'icon-image': ["step", ["zoom"],
          ['case',
            ['coalesce', ['get', 'direction_both'], false], 'sdf:general/signal-direction-both',
            'sdf:general/signal-direction',
          ],
          16, ['case',
            ['coalesce', ['get', 'direction_both'], false], 'sdf:general/signal-direction-large-both',
            'sdf:general/signal-direction-large',
          ],
        ],
        'icon-anchor': ['case',
          ['coalesce', ['get', 'direction_both'], false], 'center',
          'top',
        ],
        'icon-rotate': ['get', 'azimuth'],
        'icon-keep-upright': true,
        'icon-rotation-alignment': 'map',
      },
    },
    ...imageLayerWithOutline(
      'electrification_signals',
      ['get', 'feature'],
      {
        type: 'symbol',
        minzoom: 13,
        source: 'openrailwaymap_electrification',
        'source-layer': 'electrification_signals',
        paint: {
          'text-color': colors.text.main,
          'text-halo-color': ['case',
            ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
            colors.halo
          ],
          'text-halo-width': 1.5,
          'text-halo-blur': 1,
        },
        layout: {
          'symbol-z-order': 'source',
          'icon-overlap': 'always',
          'text-field': '{ref}',
          'text-font': font.regular,
          'text-size': 9,
          'text-optional': true,
          'text-anchor': 'top',
          'text-offset': ['literal', [0, 1.5]],
        },
      },
    ),
    {
      id: 'electrification_signals_deactivated',
      type: 'symbol',
      minzoom: 15,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_signals',
      filter: ['get', 'deactivated'],
      layout: {
        'symbol-z-order': 'source',
        'icon-overlap': 'always',
        'icon-image': 'general/signal-deactivated',
      }
    },
    {
      id: `electrification_signals_text`,
      type: 'symbol',
      minzoom: 16,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_signals',
      filter: ['any',
        ['!=', ['get', 'ref'], null],
        ['!=', ['get', 'caption'], null],
      ],
      paint: {
        'text-color': colors.text.main,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo
        ],
        'text-halo-width': 1.5,
        'text-halo-blur': 1,
      },
      layout: {
        'text-field': ['format',
          ['get', 'ref'], {},
          ['case', ['all', ['!=', ['get', 'ref'], null], ['!=', ['get', 'caption'], null]], '\n', ''], {},
          ['case', ['==', ['get', 'caption'], null], '', ['get', 'caption']], {'text-font': ['literal', font.italic]},
        ],
        'text-font': font.regular,
        'text-size': 9,
        'text-anchor': 'top',
        'text-offset': [0, 1.5],
      },
    },
    {
      id: `electrification_symbols`,
      type: 'symbol',
      minzoom: 13,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_railway_symbols',
      paint: {
        'icon-color': colors.styles.standard.symbols,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'icon-halo-blur': ['case',
          ['boolean', ['feature-state', 'hover'], false], 1.0,
          0.0,
        ],
        'icon-halo-width': ['case',
          ['boolean', ['feature-state', 'hover'], false], 3.0,
          2.0,
        ],
        'text-color': colors.styles.standard.symbols,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 2,
      },
      layout: {
        'symbol-z-order': 'source',
        'icon-overlap': 'always',
        'icon-image': ['concat', 'sdf:', ['get', 'feature']],
        'text-field': ['coalesce', ['get', 'ref'], ''],
        'text-font': font.regular,
        'text-size': 11,
        'text-padding': 15,
        'text-offset': [0, 1.5],
        'text-optional': true,
      },
    },
    {
      id: 'electrification_substation_text',
      type: 'symbol',
      minzoom: 13,
      source: 'openrailwaymap_electrification',
      'source-layer': 'electrification_substation',
      filter: ['!=', ['get', 'name'], null],
      paint: {
        'text-color': colors.substationText,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 2,
      },
      layout: {
        'text-field': '{name}',
        'text-font': font.bold,
        'text-size': 11,
        'text-padding': 6,
        'text-max-width': 5,
      },
    },
    searchResults,
  ],

  gauge: [
    hillshade,
    ...railwayLine(
      ['coalesce', ['get', 'gauge_label'], ''],
      [
        {
          id: 'railway_line_low',
          minzoom: 0,
          maxzoom: 7,
          source: 'gauge_railway_line_low',
          sourceLayer: 'gauge_railway_line_low',
          states: {
            present: undefined,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: gaugeColor('gauge0', 'gaugeint0'),
        },
        {
          id: 'railway_line_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: 2,
          color: gaugeColor('gauge0', 'gaugeint0'),
        },
        {
          id: 'railway_line_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: gauge_construction_dashes,
            disused: disused_dasharray,
            preserved: disused_dasharray,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: gaugeColor('gauge0', 'gaugeint0'),
        },
        {
          id: 'railway_line_high_dual',
          minzoom: 8,
          source: 'high',
          states: {
            present: gauge_dual_gauge_dashes,
            construction: dual_construction_dashes,
          },
          filter: ['all',
            ['!=', ['get', 'feature'], 'ferry'],
            ['!=', ['get', 'gauge1'], null],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: gaugeColor('gauge1', 'gaugeint1'),
        },
        {
          id: 'railway_line_high_multi',
          minzoom: 8,
          source: 'high',
          states: {
            present: gauge_multi_gauge_dashes,
            construction: multi_construction_dashes,
          },
          filter: ['all',
            ['!=', ['get', 'feature'], 'ferry'],
            ['!=', ['get', 'gauge2'], null],
          ],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: gaugeColor('gauge2', 'gaugeint2'),
        },
      ],
    ),
    searchResults,
  ],

  loading_gauge: [
    hillshade,
    ...railwayLine(
      ['coalesce', ['get', 'loading_gauge'], ''],
      [
        {
          id: 'railway_line_low',
          minzoom: 0,
          maxzoom: 7,
          source: 'loading_gauge_railway_line_low',
          sourceLayer: 'loading_gauge_railway_line_low',
          states: {
            present: undefined,
          },
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: loadingGaugeFillColor,
        },
        {
          id: 'railway_line_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
          },
          width: 2,
          color: loadingGaugeFillColor,
        },
        {
          id: 'railway_line_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
            disused: disused_dasharray,
            preserved: disused_dasharray,
          },
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: loadingGaugeFillColor,
        },
      ],
    ),
    searchResults,
  ],

  track_class: [
    hillshade,
    ...railwayLine(
      ['coalesce', ['get', 'track_class'], ''],
      [
        {
          id: 'railway_line_low',
          minzoom: 0,
          maxzoom: 7,
          source: 'track_class_railway_line_low',
          sourceLayer: 'track_class_railway_line_low',
          states: {
            present: undefined,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: trackClassFillColor,
        },
        {
          id: 'railway_line_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: 2,
          color: trackClassFillColor,
        },
        {
          id: 'railway_line_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
            disused: disused_dasharray,
            preserved: disused_dasharray,
          },
          filter: ['!=', ['get', 'feature'], 'ferry'],
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: trackClassFillColor,
        },
      ],
    ),
    searchResults,
  ],
  operator: [
    hillshade,
    {
      id: 'railway_grouped_stations',
      type: 'fill',
      minzoom: 13,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_grouped_stations',
      filter: ['all',
        ['!=', ['get', 'operator'], null],
        ['match', ['get', 'state'],
          'construction', ['global-state', 'showConstructionInfrastructure'],
          'proposed', ['global-state', 'showProposedInfrastructure'],
          'abandoned', ['global-state', 'showAbandonedInfrastructure'],
          'razed', ['global-state', 'showRazedInfrastructure'],
          true,
        ],
      ],
      paint: {
        'fill-color': ['get', 'operator_color'],
        'fill-opacity': ['case',
          ['boolean', ['feature-state', 'hover'], false], 0.3,
          0.2,
        ],
      },
    },
    ...Object.entries({
      present: present_dasharray,
      disused: disused_dasharray,
      abandoned: abandoned_dasharray,
      preserved: disused_dasharray,
      construction: construction_dasharray,
      proposed: proposed_dasharray,
    }).map(([state, dasharray]) => ({
      id: `railway_grouped_stations_outline_${state}`,
      type: 'line',
      minzoom: 13,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_grouped_stations',
      filter: ['all',
        ['!=', ['get', 'operator'], null],
        ['==', ['get', 'state'], state],
      ],
      paint: {
        'line-color': ['get', 'operator_color'],
        'line-opacity': 0.3,
        'line-width': 2 ,
        'line-dasharray': dasharray,
      },
      layout: {
        'visibility': ['case',
          state === 'construction' ? ['global-state', 'showConstructionInfrastructure']
            : state === 'proposed' ? ['global-state', 'showProposedInfrastructure']
              : state === 'abandoned' ? ['global-state', 'showAbandonedInfrastructure']
                : state === 'razed' ? ['global-state', 'showRazedInfrastructure']
                  : true, 'visible',
          'none',
        ],
    }
    })),
    ...railwayLine(
      ['coalesce', ['get', 'primary_operator'], ''],
      [
        {
          id: 'railway_line_low',
          minzoom: 0,
          maxzoom: 7,
          source: 'operator_railway_line_low',
          sourceLayer: 'operator_railway_line_low',
          states: {
            present: undefined,
          },
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            0, 0.5,
            7, 2,
          ],
          color: ['coalesce', ['get', 'operator_color'], 'gray'],
        },
        {
          id: 'railway_line_med',
          minzoom: 7,
          maxzoom: 8,
          source: 'openrailwaymap_low',
          states: {
            present: undefined,
          },
          width: 2,
          color: ['coalesce', ['get', 'operator_color'], 'gray'],
        },
        {
          id: 'railway_line_high',
          minzoom: 8,
          source: 'high',
          states: {
            present: undefined,
            construction: construction_dasharray,
            proposed: proposed_dasharray,
            disused: disused_dasharray,
            preserved: disused_dasharray,
          },
          width: ["interpolate", ["exponential", 1.2], ["zoom"],
            14, 2,
            16, 3,
          ],
          color: ['coalesce', ['get', 'operator_color'], 'gray'],
        },
      ],
    ),
    {
      id: 'signal_boxes_point',
      type: 'circle',
      minzoom: 10,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['all',
        ['!=', ["get", 'operator'], null],
        ['==', ["geometry-type"], 'Point'],
      ],
      paint: {
        'circle-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          ['get', 'operator_color'],
        ],
        'circle-radius': 4,
        'circle-stroke-color': 'white',
        'circle-stroke-width': 1,
      },
    },
    {
      id: 'signal_boxes_polygon',
      type: 'fill',
      minzoom: 14,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['all',
        ['!=', ["get", 'operator'], null],
        ['any',
          ['==', ["geometry-type"], 'Polygon'],
          ['==', ["geometry-type"], 'MultiPolygon'],
        ],
      ],
      paint: {
        'fill-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.main,
          ['get', 'operator_color'],
        ],
        'fill-outline-color': 'white',
      },
    },
    {
      id: 'signal_boxes_polygon_outline',
      type: 'line',
      minzoom: 14,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['all',
        ['!=', ["get", 'operator'], null],
        ['any',
          ['==', ["geometry-type"], 'Polygon'],
          ['==', ["geometry-type"], 'MultiPolygon'],
        ],
      ],
      paint: {
        'line-color': 'white',
        'line-width': 1,
      },
    },
    {
      id: 'railway_text_stations_low1',
      type: 'symbol',
      minzoom: 4,
      maxzoom: 5,
      source: 'standard_railway_text_stations_low',
      'source-layer': 'standard_railway_text_stations_low',
      filter: ['!=', ['get', 'operator'], null],
      paint: {
        'icon-color': ['get', 'operator_color'],
        'icon-halo-width': 1,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'symbol-z-order': 'source',
        'icon-image': 'sdf:general/station-small',
        'icon-overlap': 'always',
      },
    },
    {
      id: 'railway_text_stations_low2',
      type: 'symbol',
      minzoom: 5,
      maxzoom: 7,
      source: 'standard_railway_text_stations_low',
      'source-layer': 'standard_railway_text_stations_low',
      filter: ['!=', ['get', 'operator'], null],
      paint: {
        'text-color': ['get', 'operator_color'],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
        'icon-color': ['get', 'operator_color'],
        'icon-halo-width': 1.5,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'symbol-z-order': 'source',
        'icon-image': ['image', ['concat', 'sdf:general/station-', ['get', 'station_size']]],
        'icon-overlap': 'always',
        'text-field': ['match', ['global-state', 'stationLowZoomLabel'],
          'label', ['get', 'label'],
          'name', ['get', 'localized_name'],
          '',
        ],
        'text-font': font.bold,
        'text-size': 11,
        'text-padding': 10,
        'text-max-width': 8,
        'text-optional': true,
        'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
      },
    },
    {
      id: 'railway_text_stations_med',
      type: 'symbol',
      minzoom: 7,
      maxzoom: 8,
      source: 'standard_railway_text_stations_med',
      'source-layer': 'standard_railway_text_stations_med',
      filter: ['!=', ['get', 'operator'], null],
      paint: {
        'text-color': ['get', 'operator_color'],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 2,
        'icon-color': ['get', 'operator_color'],
        'icon-halo-width': 2,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'symbol-z-order': 'source',
        'icon-image': ['image', ['concat', 'sdf:general/station-', ['get', 'station_size']]],
        'icon-overlap': 'always',
        'text-field': ['match', ['get', 'station_size'],
          'small', '',
          ['match', ['global-state', 'stationLowZoomLabel'],
            'label', ['get', 'label'],
            'name', ['get', 'localized_name'],
            '',
          ],
        ],
        'text-font': font.bold,
        'text-size': 11,
        'text-padding': 10,
        'text-max-width': 8,
        'text-optional': true,
        'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
      },
    },
    {
      id: 'railway_text_stations',
      type: 'symbol',
      minzoom: 8,
      maxzoom: 13,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_text_stations',
      filter: ['step', ['zoom'],
        ['all',
          ['!=', ['get', 'operator'], null],
          ['==', ['get', 'state'], 'present'],
          ['any',
            ['==', ['get', 'feature'], 'station'],
            ['==', ['get', 'feature'], 'yard'],
          ],
          ['!=', ['get', 'station'], 'light_rail'],
          ['!=', ['get', 'station'], 'subway'],
          ['!=', ['get', 'station'], 'monorail'],
          ['!=', ['get', 'station'], 'funicular'],
        ],
        9,
        ['all',
          ['!=', ['get', 'operator'], null],
          ['==', ['get', 'state'], 'present'],
          ['any',
            ['==', ['get', 'feature'], 'station'],
            ['==', ['get', 'feature'], 'yard'],
            ['==', ['get', 'feature'], 'halt'],
          ],
          ['!=', ['get', 'station'], 'light_rail'],
          ['!=', ['get', 'station'], 'tram'],
          ['!=', ['get', 'station'], 'subway'],
          ['!=', ['get', 'station'], 'monorail'],
          ['!=', ['get', 'station'], 'funicular'],
        ],
        10,
        ['all',
          ['!=', ['get', 'operator'], null],
          ['!=', ['get', 'station'], 'tram'],
          ['!=', ['get', 'station'], 'funicular'],
          ['!=', ['get', 'station'], 'miniature'],
        ],
        11,
        ['all',
          ['!=', ['get', 'operator'], null],
          ['!=', ['get', 'station'], 'funicular'],
          ['!=', ['get', 'station'], 'miniature'],
        ],
      ],
      paint: {
        'text-color': ['get', 'operator_color'],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
        'icon-color': ['get', 'operator_color'],
        'icon-halo-width': 1.5,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
      },
      layout: {
        'symbol-z-order': 'source',
        'icon-image': ['image', ['concat', 'sdf:general/station-', ['case',
          ['in', ['get', 'state'], ['literal', ['disused', 'abandoned', 'preserved', 'razed']]], 'past',
          ['in', ['get', 'state'], ['literal', ['construction', 'proposed']]], 'future',
          ['get', 'station_size'],
        ]]],
        'icon-overlap': 'always',
        'text-field': ['step', ['zoom'],
          ['match', ['global-state', 'stationLowZoomLabel'],
            'label', ['get', 'label'],
            'name', ['get', 'localized_name'],
            '',
          ],
          10,
          ['get', 'localized_name'],
          12,
          ['format',
            ['get', 'localized_name'],
            {},
            ['case',
              ['!=', ['get', 'name'], ['get', 'localized_name']], ['concat', '\n', ['get', 'name']],
              '',
            ],
            {
              'text-font': ['literal', font.regular],
            },
          ],
        ],
        'text-font': ['case',
          ['in', ['get', 'state'], ['literal', ['construction', 'proposed']]], ['literal', font.italic],
          ['literal', font.bold],
        ],
        'text-size': 11,
        'text-padding': 10,
        'text-max-width': 8,
        'text-optional': true,
        'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
      },
    },
    {
      id: 'railway_text_stations_high',
      type: 'symbol',
      minzoom: 13,
      source: 'openrailwaymap_standard',
      'source-layer': 'standard_railway_text_stations',
      filter: ['!=', ['get', 'operator'], null],
      paint: {
        'text-color': ['get', 'operator_color'],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
      },
      layout: {
        'symbol-z-order': 'source',
        'text-field': ['step', ['zoom'],
          ['format',
            ['get', 'localized_name'],
            {},
            ['case',
              ['!=', ['get', 'name'], ['get', 'localized_name']], ['concat', '\n', ['get', 'name']],
              '',
            ],
            {
              'text-font': ['literal', font.regular],
            },
          ],
          15,
          ['format',
            ['get', 'localized_name'],
            {},
            ['case',
              ['>', ['coalesce', ['get', 'count'], 0], 1], ['concat', ' (', ['get', 'count'], ')'],
              '',
            ],
            {},
            ['case',
              ['!=', ['get', 'name'], ['get', 'localized_name']], ['concat', '\n', ['get', 'name']],
              '',
            ],
            {
              'text-font': ['literal', font.regular],
            },
          ],
        ],
        'text-font': ['case',
          ['in', ['get', 'state'], ['literal', ['construction', 'proposed']]], ['literal', font.italic],
          ['literal', font.bold],
        ],
        'text-variable-anchor': ['center', 'top', 'bottom', 'left', 'right'],
        'text-size': 11,
        'text-padding': 10,
        'text-max-width': 8,
      },
    },
    {
      id: 'signal_boxes_text_medium',
      type: 'symbol',
      minzoom: 12,
      maxzoom: 15,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['all',
        ['!=', ["get", 'operator'], null],
        ['!=', ['get', 'ref'], null],
      ],
      paint: {
        'text-color': ['get', 'operator_color'],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
      },
      layout: {
        'text-field': '{ref}',
        'text-font': font.bold,
        'text-size': 11,
        'text-offset': ['literal', [0, 1]],
      }
    },
    {
      id: 'signal_boxes_text_high',
      type: 'symbol',
      minzoom: 15,
      source: 'openrailwaymap_signals',
      'source-layer': 'signals_signal_boxes',
      filter: ['all',
        ['!=', ["get", 'operator'], null],
        ['!=', ['get', 'name'], null],
      ],
      paint: {
        'text-color': ['get', 'operator_color'],
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 1.5,
      },
      layout: {
        'text-field': '{name}',
        'text-font': font.bold,
        'text-size': 11,
      }
    },
    {
      id: `operator_symbols`,
      type: 'symbol',
      minzoom: 10,
      source: 'openrailwaymap_operator',
      'source-layer': 'operator_railway_symbols',
      paint: {
        'icon-color': colors.styles.standard.symbols,
        'icon-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'icon-halo-blur': ['case',
          ['boolean', ['feature-state', 'hover'], false], 1.0,
          0.0,
        ],
        'icon-halo-width': ['case',
          ['boolean', ['feature-state', 'hover'], false], 3.0,
          2.0,
        ],
        'text-color': colors.styles.standard.symbols,
        'text-halo-color': ['case',
          ['boolean', ['feature-state', 'hover'], false], colors.hover.textHalo,
          colors.halo,
        ],
        'text-halo-width': 2,
      },
      layout: {
        'symbol-z-order': 'source',
        'icon-overlap': 'always',
        'icon-image': ['concat', 'sdf:', ['get', 'feature']],
        'text-field': ['coalesce', ['get', 'ref'], ''],
        'text-font': font.regular,
        'text-size': 11,
        'text-padding': 15,
        'text-offset': [0, 1.5],
        'text-optional': true,
      },
    },
    ...imageLayerWithOutline(
      `operator_symbols_outline`,
      ['get', 'feature'],
      {
        type: 'symbol',
        minzoom: 10,
        source: 'openrailwaymap_operator',
        'source-layer': 'operator_railway_symbols',
        layout: {
          'symbol-z-order': 'source',
          'icon-overlap': 'always',
        },
      },
    ),
    searchResults,
  ],
};

const makeStyle = selectedStyle => ({
  center: [12.55, 51.14], // default
  zoom: 3.75, // default
  glyphs: '/font/{fontstack}/{range}',
  metadata: {},
  name: `OpenRailwayMap ${selectedStyle}`,
  sources,
  sprite: [
    {
      id: 'sdf',
      url: '/sdf_sprite/symbols'
    },
    {
      id: 'default',
      url: '/sprite/symbols'
    }
  ],
  version: 8,
  layers: layers[selectedStyle],
  state: {
    date: {
      default: defaultDate,
    },
    allDates: {
      default: false,
    },
    theme: {
      default: 'light',
    },
    stationLowZoomLabel: {
      default: 'label',
    },
    showConstructionInfrastructure: {
      default: true,
    },
    showProposedInfrastructure: {
      default: true,
    },
    showAbandonedInfrastructure: {
      default: false,
    },
    showRazedInfrastructure: {
      default: false,
    },
    openHistoricalMap: {
      default: true,
    },
    hillshade: {
      default: false,
    },
    electrificationRailwayLine: {
      default: 'voltageFrequency',
    },
  },
});

knownStyles.forEach(style => {
  fs.writeFileSync(`${style}.json`, JSON.stringify(makeStyle(style)));
});
